const E="xupload-btn",g="xupload-panel",h=new WeakSet,k=/upload|browse|choose file|select file|‰∏ä‰º†|ÈÄâÊã©Êñá‰ª∂|ÈôÑ‰ª∂|attach/i;let f=null;function $(){const e=[];return document.querySelectorAll('input[type="file"]').forEach(n=>{h.has(n)||F(n)&&e.push({anchor:n,fileInput:n,context:D(n),accept:n.accept||void 0})}),document.querySelectorAll('button, a, [role="button"], label[for], .upload-btn, [class*="upload"], [class*="Upload"]').forEach(n=>{if(h.has(n))return;const a=n.textContent||"";if(!k.test(a)||n.querySelector(`.${E}`)||n.closest(`.${g}`))return;const o=S(n);e.push({anchor:n,fileInput:o,context:j(n),accept:(o==null?void 0:o.accept)||void 0})}),e}function F(e){const t=getComputedStyle(e);return t.display!=="none"&&t.visibility!=="hidden"&&e.offsetWidth>0&&e.offsetHeight>0}function S(e){const t=e.querySelector('input[type="file"]');if(t)return t;const n=e.parentElement;if(n){const o=n.querySelector('input[type="file"]');if(o)return o}let a=e;for(let o=0;o<3&&a;o++)if(a=a.parentElement,a){const c=a.querySelector('input[type="file"]');if(c)return c}return null}function D(e){const t=[];if(e.id){const c=document.querySelector(`label[for="${e.id}"]`);c&&t.push(c.textContent||"")}const n=e.closest("label");n&&t.push(n.textContent||""),e.placeholder&&t.push(e.placeholder),e.title&&t.push(e.title);const a=e.getAttribute("aria-label");a&&t.push(a);const o=e.closest("[class*='upload'], [class*='Upload'], div, fieldset, section, td, li")||e.parentElement;return o&&t.push((o.textContent||"").slice(0,300)),t.join(" ").trim()}function j(e){const t=[];t.push(e.textContent||"");const n=e.getAttribute("aria-label");n&&t.push(n);const a=e.closest("[class*='upload'], [class*='Upload'], div, fieldset, section, td, li")||e.parentElement;return a&&t.push((a.textContent||"").slice(0,300)),t.join(" ").trim()}function A(e){const t=document.createElement("button");return t.type="button",t.className=E,t.textContent="‚ö°",t.title="xUpload: Smart file recommendation",t.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),I(e,t)}),t}async function N(e,t){const n=[];for await(const a of e.values()){const o=t?`${t}/${a.name}`:a.name;if(a.kind==="file")n.push({fileHandle:a,path:o});else if(a.kind==="directory"&&!a.name.startsWith(".")){const c=await N(a,o);n.push(...c)}}return n}function H(e){var a;const t=((a=e.split(".").pop())==null?void 0:a.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[t]||"application/octet-stream"}const M=["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"];async function P(e){var a;const t=e.name.replace(/[._-]/g," "),n=((a=e.name.split(".").pop())==null?void 0:a.toLowerCase())||"";if(M.includes(n))try{const o=await e.text();return`${t} ${o.slice(0,2e3)}`}catch{return t}if(n==="pdf")try{const o=await e.arrayBuffer(),c=new Uint8Array(o);let d="";const l=Math.min(c.length,5e5);for(let p=0;p<l;p++)d+=String.fromCharCode(c[p]);const s=[],r=/BT\s([\s\S]*?)ET/g;let i;for(;(i=r.exec(d))!==null;){const p=/\(([^)]*)\)/g;let m;for(;(m=p.exec(i[1]))!==null;)s.push(m[1])}const x=s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim();return`${t} ${x.slice(0,2e3)}`}catch{return t}return t}async function B(e){try{f=await window.showDirectoryPicker({mode:"read"})}catch(o){return o.name==="AbortError"||console.error("[xUpload] Folder picker error:",o),!1}if(!f)return!1;e&&(e.textContent="Scanning files...");const t=await N(f,"");e&&(e.textContent=`Found ${t.length} files. Reading...`);const n=[];for(let o=0;o<t.length;o++){const{fileHandle:c,path:d}=t[o];try{const l=await c.getFile(),s=await P(l);n.push({path:d,name:l.name,type:l.type||H(l.name),size:l.size,lastModified:l.lastModified,text:s})}catch{}o%10===0&&e&&(e.textContent=`Reading files... ${o+1}/${t.length}`)}e&&(e.textContent="Building index...");const a=await chrome.runtime.sendMessage({type:"BUILD_INDEX",files:n});return console.log("[xUpload] Index built:",a),e&&(e.textContent=`Done! ${(a==null?void 0:a.count)||n.length} files indexed.`),!0}async function I(e,t){var n;document.querySelectorAll(`.${g}`).forEach(a=>a.remove()),console.log("[xUpload] ‚ö° clicked! Context:",e.context.slice(0,100));try{const a=await chrome.runtime.sendMessage({type:"GET_INDEX_COUNT"});if(!(a!=null&&a.count)||a.count===0){_(t,e);return}await T(t,e)}catch(a){console.error("[xUpload] Error:",a);const o=(n=a==null?void 0:a.message)!=null&&n.includes("Extension context invalidated")?"Extension was updated. Please refresh this page.":"Error getting recommendations.";C(t,e,[],o)}}function _(e,t){const n=document.createElement("div");n.className=g;const a=document.createElement("div");a.className="xupload-header",a.textContent="‚ö° xUpload",n.appendChild(a);const o=document.createElement("div");o.className="xupload-empty",o.textContent="No files indexed yet.",n.appendChild(o);const c=document.createElement("button");c.type="button",c.className="xupload-scan-btn",c.textContent="Select folder to scan",c.style.cssText="display:block;width:100%;margin-top:8px;padding:8px 12px;background:#4285f4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;",c.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),c.disabled=!0,c.textContent="Scanning...",await B(o)?(n.remove(),await T(e,t)):(c.disabled=!1,c.textContent="Select folder to scan",o.textContent="Scan cancelled. Try again.")}),n.appendChild(c);const d=s=>{n.contains(s.target)||(n.remove(),document.removeEventListener("click",d))};setTimeout(()=>document.addEventListener("click",d),0);const l=e.getBoundingClientRect();n.style.position="fixed",n.style.top=`${l.bottom+4}px`,n.style.left=`${l.left}px`,document.body.appendChild(n)}async function T(e,t){var o;const n={type:"MATCH_REQUEST",context:t.context,accept:t.accept},a=await chrome.runtime.sendMessage(n);if(console.log("[xUpload] Response:",a),!((o=a==null?void 0:a.results)!=null&&o.length)){C(e,t,[],"No matching files found.");return}console.log("[xUpload] Showing",a.results.length,"results"),C(e,t,a.results)}function C(e,t,n,a){const o=document.createElement("div");o.className=g;const c=document.createElement("div");if(c.className="xupload-header",c.textContent=n.length>0?`‚ö° ${n.length} files recommended`:"‚ö° xUpload",o.appendChild(c),n.length===0){const s=document.createElement("div");s.className="xupload-empty",s.textContent=a||"No results",o.appendChild(s)}else{const s=document.createElement("ul");for(const r of n){const i=document.createElement("li");i.className="xupload-item";const x=document.createElement("span");x.className="xupload-icon",x.textContent=q(r.type,r.name);const p=document.createElement("div");p.className="xupload-info";const m=document.createElement("span");m.className="xupload-name",m.textContent=r.name;const y=document.createElement("span");y.className="xupload-path",y.textContent=r.path,p.appendChild(m),p.appendChild(y);const u=document.createElement("span");u.className="xupload-score";const L=Math.round(r.score*100);u.textContent=`${L}%`,i.appendChild(x),i.appendChild(p),i.appendChild(u),i.title=`Click to select: ${r.name}`,i.addEventListener("click",async b=>{b.preventDefault(),b.stopPropagation(),u.textContent="...",i.classList.add("xupload-loading"),await R(t,r.id,r.name,r.type)?(i.classList.remove("xupload-loading"),i.classList.add("xupload-done"),u.textContent="‚úì",setTimeout(()=>o.remove(),600)):(i.classList.remove("xupload-loading"),u.textContent="Error",u.style.color="#ea4335")}),s.appendChild(i)}o.appendChild(s)}const d=s=>{o.contains(s.target)||(o.remove(),document.removeEventListener("click",d))};setTimeout(()=>document.addEventListener("click",d),0);const l=e.getBoundingClientRect();o.style.position="fixed",o.style.top=`${l.bottom+4}px`,o.style.left=`${l.left}px`,document.body.appendChild(o)}function q(e,t){var a;const n=((a=t.split(".").pop())==null?void 0:a.toLowerCase())||"";return n==="pdf"||e==="application/pdf"?"üìÑ":["doc","docx"].includes(n)?"üìÉ":["jpg","jpeg","png","gif","webp"].includes(n)?"üñºÔ∏è":["xls","xlsx","csv"].includes(n)?"üìä":"üìÅ"}async function v(e){if(!f)return null;try{const t=e.split("/");let n=f;for(let o=0;o<t.length-1;o++)n=await n.getDirectoryHandle(t[o]);return await(await n.getFileHandle(t[t.length-1])).getFile()}catch(t){return console.error("[xUpload] Failed to read file from handle:",t),null}}function w(e,t){const n=new DataTransfer;n.items.add(t),e.files=n.files,e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0}))}async function R(e,t,n,a){try{let o=await v(t);if(!o){console.log("[xUpload] No handle, asking user to select folder");try{f=await window.showDirectoryPicker({mode:"read"}),f&&(o=await v(t))}catch(r){r.name!=="AbortError"&&console.error("[xUpload] Folder picker error:",r)}}if(!o)return console.error("[xUpload] Could not read file:",t),!1;if(e.fileInput)return w(e.fileInput,o),!0;const c=S(e.anchor);if(c)return w(c,o),!0;const d=e.anchor.closest("[class*='upload'], [class*='Upload'], [class*='drop']")||e.anchor,l=new DataTransfer;l.items.add(o);const s=new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:l});return d.dispatchEvent(s),!0}catch(o){return console.error("[xUpload] Fill error:",o),!1}}function U(){const e=$();for(const t of e){if(h.has(t.anchor))continue;h.add(t.anchor);const n=A(t);t.anchor.insertAdjacentElement("afterend",n)}}U();const O=new MutationObserver(()=>U());O.observe(document.body,{childList:!0,subtree:!0});
