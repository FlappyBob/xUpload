const S="xupload-btn",v="xupload-panel",C=new WeakSet,R=/upload|browse|choose file|select file|ä¸Šä¼ |é€‰æ‹©æ–‡ä»¶|é™„ä»¶|attach/i;let g=null;function B(){const t=[];return document.querySelectorAll('input[type="file"]').forEach(e=>{C.has(e)||H(e)&&t.push({anchor:e,fileInput:e,context:M(e),accept:e.accept||void 0})}),document.querySelectorAll('button, a, [role="button"], label[for], .upload-btn, [class*="upload"], [class*="Upload"]').forEach(e=>{if(C.has(e))return;const a=e.textContent||"";if(!R.test(a)||e.querySelector(`.${S}`)||e.closest(`.${v}`))return;const o=T(e);t.push({anchor:e,fileInput:o,context:I(e),accept:(o==null?void 0:o.accept)||void 0})}),t}function H(t){const n=getComputedStyle(t);return n.display!=="none"&&n.visibility!=="hidden"&&t.offsetWidth>0&&t.offsetHeight>0}function T(t){const n=t.querySelector('input[type="file"]');if(n)return n;const e=t.parentElement;if(e){const o=e.querySelector('input[type="file"]');if(o)return o}let a=t;for(let o=0;o<3&&a;o++)if(a=a.parentElement,a){const c=a.querySelector('input[type="file"]');if(c)return c}return null}function M(t){const n=[];if(t.id){const c=document.querySelector(`label[for="${t.id}"]`);c&&n.push(c.textContent||"")}const e=t.closest("label");e&&n.push(e.textContent||""),t.placeholder&&n.push(t.placeholder),t.title&&n.push(t.title);const a=t.getAttribute("aria-label");a&&n.push(a);const o=t.closest("[class*='upload'], [class*='Upload'], div, fieldset, section, td, li")||t.parentElement;return o&&n.push((o.textContent||"").slice(0,300)),n.join(" ").trim()}function I(t){const n=[];n.push(t.textContent||"");const e=t.getAttribute("aria-label");e&&n.push(e);const a=t.closest("[class*='upload'], [class*='Upload'], div, fieldset, section, td, li")||t.parentElement;return a&&n.push((a.textContent||"").slice(0,300)),n.join(" ").trim()}function P(t){const n=document.createElement("button");return n.type="button",n.className=S,n.textContent="âš¡",n.title="xUpload: Smart file recommendation",n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),z(t,n)}),n}async function k(t,n){const e=[];for await(const a of t.values()){const o=n?`${n}/${a.name}`:a.name;if(a.kind==="file")e.push({fileHandle:a,path:o});else if(a.kind==="directory"&&!a.name.startsWith(".")){const c=await k(a,o);e.push(...c)}}return e}function O(t){var a;const n=((a=t.split(".").pop())==null?void 0:a.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[n]||"application/octet-stream"}const $=["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"];async function _(t){var a;const n=t.name.replace(/[._-]/g," "),e=((a=t.name.split(".").pop())==null?void 0:a.toLowerCase())||"";if($.includes(e))try{const o=await t.text();return`${n} ${o.slice(0,2e3)}`}catch{return n}if(e==="pdf")try{const o=await t.arrayBuffer(),c=new Uint8Array(o);let m="";const p=Math.min(c.length,5e5);for(let u=0;u<p;u++)m+=String.fromCharCode(c[u]);const s=[],l=/BT\s([\s\S]*?)ET/g;let r;for(;(r=l.exec(m))!==null;){const u=/\(([^)]*)\)/g;let d;for(;(d=u.exec(r[1]))!==null;)s.push(d[1])}const x=s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim();return`${n} ${x.slice(0,2e3)}`}catch{return n}return n}async function q(t){try{g=await window.showDirectoryPicker({mode:"read"})}catch(o){return o.name==="AbortError"||console.error("[xUpload] Folder picker error:",o),!1}if(!g)return!1;t&&(t.textContent="Scanning files...");const n=await k(g,"");t&&(t.textContent=`Found ${n.length} files. Reading...`);const e=[];for(let o=0;o<n.length;o++){const{fileHandle:c,path:m}=n[o];try{const p=await c.getFile(),s=await _(p);e.push({path:m,name:p.name,type:p.type||O(p.name),size:p.size,lastModified:p.lastModified,text:s})}catch{}o%10===0&&t&&(t.textContent=`Reading files... ${o+1}/${n.length}`)}t&&(t.textContent="Building index...");const a=await chrome.runtime.sendMessage({type:"BUILD_INDEX",files:e});return console.log("[xUpload] Index built:",a),t&&(t.textContent=`Done! ${(a==null?void 0:a.count)||e.length} files indexed.`),!0}async function z(t,n){var e;document.querySelectorAll(`.${v}`).forEach(a=>a.remove()),console.log("[xUpload] âš¡ clicked! Context:",t.context.slice(0,100));try{const a=await chrome.runtime.sendMessage({type:"GET_INDEX_COUNT"});if(!(a!=null&&a.count)||a.count===0){W(n,t);return}await E(n,t)}catch(a){console.error("[xUpload] Error:",a);const o=(e=a==null?void 0:a.message)!=null&&e.includes("Extension context invalidated")?"Extension was updated. Please refresh this page.":"Error getting recommendations.";w(n,t,[],o)}}function W(t,n){const e=document.createElement("div");e.className=v;const a=document.createElement("div");a.className="xupload-header",a.textContent="âš¡ xUpload",e.appendChild(a);const o=document.createElement("div");o.className="xupload-empty",o.textContent="No files indexed yet.",e.appendChild(o);const c=document.createElement("button");c.type="button",c.className="xupload-scan-btn",c.textContent="Select folder to scan",c.style.cssText="display:block;width:100%;margin-top:8px;padding:8px 12px;background:#4285f4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:13px;",c.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),c.disabled=!0,c.textContent="Scanning...",await q(o)?(e.remove(),await E(t,n)):(c.disabled=!1,c.textContent="Select folder to scan",o.textContent="Scan cancelled. Try again.")}),e.appendChild(c);const m=s=>{e.contains(s.target)||(e.remove(),document.removeEventListener("click",m))};setTimeout(()=>document.addEventListener("click",m),0);const p=t.getBoundingClientRect();e.style.position="fixed",e.style.top=`${p.bottom+4}px`,e.style.left=`${p.left}px`,document.body.appendChild(e)}async function E(t,n){var o;const e={type:"MATCH_REQUEST",context:n.context,accept:n.accept,pageUrl:window.location.href},a=await chrome.runtime.sendMessage(e);if(console.log("[xUpload] Response:",a),!((o=a==null?void 0:a.results)!=null&&o.length)){w(t,n,[],"No matching files found.");return}console.log("[xUpload] Showing",a.results.length,"results"),w(t,n,a.results)}function w(t,n,e,a){const o=document.createElement("div");o.className=v;const c=document.createElement("div");if(c.className="xupload-header",c.textContent=e.length>0?`âš¡ ${e.length} files recommended`:"âš¡ xUpload",o.appendChild(c),e.length===0){const s=document.createElement("div");s.className="xupload-empty",s.textContent=a||"No results",o.appendChild(s)}else{const s=document.createElement("ul");for(const l of e){const r=document.createElement("li");r.className="xupload-item";const x=document.createElement("span");x.className="xupload-icon",x.textContent=D(l.type,l.name);const u=document.createElement("div");u.className="xupload-info";const d=document.createElement("span");d.className="xupload-name",d.textContent=l.name;const y=document.createElement("span");if(y.className="xupload-path",y.textContent=l.path,u.appendChild(d),u.appendChild(y),l.historyCount&&l.historyCount>0){const f=document.createElement("span");f.className="xupload-history-badge",f.textContent=`Used ${l.historyCount}x here`,u.appendChild(f)}const h=document.createElement("span");h.className="xupload-score";const i=Math.round(l.score*100);h.textContent=`${i}%`,r.appendChild(x),r.appendChild(u),r.appendChild(h),r.title=`Click to select: ${l.name}`,r.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation(),h.textContent="...",r.classList.add("xupload-loading");const L=await G(l.id);if(r.classList.remove("xupload-loading"),h.textContent=`${i}%`,!L){h.textContent="Error",h.style.color="#ea4335";return}o.remove(),Q(t,n,L,l)}),s.appendChild(r)}o.appendChild(s)}const m=s=>{o.contains(s.target)||(o.remove(),document.removeEventListener("click",m))};setTimeout(()=>document.addEventListener("click",m),0);const p=t.getBoundingClientRect();o.style.position="fixed",o.style.top=`${p.bottom+4}px`,o.style.left=`${p.left}px`,document.body.appendChild(o)}function D(t,n){var a;const e=((a=n.split(".").pop())==null?void 0:a.toLowerCase())||"";return e==="pdf"||t==="application/pdf"?"ðŸ“„":["doc","docx"].includes(e)?"ðŸ“ƒ":["jpg","jpeg","png","gif","webp"].includes(e)?"ðŸ–¼ï¸":["xls","xlsx","csv"].includes(e)?"ðŸ“Š":"ðŸ“"}const X=["jpg","jpeg","png","gif","webp","bmp","svg"];function K(t){var n;return((n=t.split(".").pop())==null?void 0:n.toLowerCase())||""}async function G(t){let n=await U(t);if(!n)try{g=await window.showDirectoryPicker({mode:"read"}),g&&(n=await U(t))}catch(e){e.name!=="AbortError"&&console.error("[xUpload] Folder picker error:",e)}return n}function Q(t,n,e,a){document.querySelectorAll(`.${v}`).forEach(i=>i.remove());const o=document.createElement("div");o.className=v+" xupload-preview";const c=document.createElement("div");c.className="xupload-header",c.innerHTML="";const m=document.createElement("span");m.textContent=D(a.type,a.name),m.style.marginRight="6px";const p=document.createElement("span");p.textContent=a.name,c.appendChild(m),c.appendChild(p),o.appendChild(c);const s=document.createElement("div");s.className="xupload-preview-content",o.appendChild(s);const l=K(e.name),r=URL.createObjectURL(e);if(X.includes(l)){const i=document.createElement("img");i.src=r,i.className="xupload-preview-img",i.alt=e.name,s.appendChild(i)}else if(l==="pdf"){const i=document.createElement("embed");i.src=r,i.type="application/pdf",i.className="xupload-preview-pdf",s.appendChild(i)}else if($.includes(l)){const i=document.createElement("pre");i.className="xupload-preview-text",e.text().then(f=>{i.textContent=f.slice(0,5e3),f.length>5e3&&(i.textContent+=`

... (truncated)`)}),s.appendChild(i)}else{const i=document.createElement("div");i.className="xupload-preview-info",i.textContent=`${e.name} (${(e.size/1024).toFixed(1)} KB)`,s.appendChild(i)}const x=document.createElement("div");x.className="xupload-preview-actions";const u=document.createElement("button");u.type="button",u.className="xupload-preview-btn xupload-preview-back",u.textContent="Back",u.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),URL.revokeObjectURL(r),o.remove(),E(t,n)});const d=document.createElement("button");d.type="button",d.className="xupload-preview-btn xupload-preview-use",d.textContent="Use this file",d.addEventListener("click",async i=>{i.preventDefault(),i.stopPropagation(),d.disabled=!0,d.textContent="Filling...";const f=await V(n,e);if(URL.revokeObjectURL(r),f){d.textContent="âœ“ Done",d.classList.add("xupload-preview-done"),setTimeout(()=>o.remove(),600);try{chrome.runtime.sendMessage({type:"TRACK_UPLOAD",entry:{fileId:a.id,fileName:a.name,fileType:a.type,websiteHost:new URL(window.location.href).hostname,pageUrl:window.location.href,pageTitle:document.title,uploadContext:n.context.slice(0,200),timestamp:Date.now()}})}catch{}}else d.textContent="Error",d.disabled=!1}),x.appendChild(u),x.appendChild(d),o.appendChild(x);const y=i=>{o.contains(i.target)||(URL.revokeObjectURL(r),o.remove(),document.removeEventListener("click",y))};setTimeout(()=>document.addEventListener("click",y),0);const h=t.getBoundingClientRect();o.style.position="fixed",o.style.top=`${Math.min(h.bottom+4,window.innerHeight-500)}px`,o.style.left=`${h.left}px`,document.body.appendChild(o)}function V(t,n){try{if(t.fileInput)return N(t.fileInput,n),!0;const e=T(t.anchor);if(e)return N(e,n),!0;const a=t.anchor.closest("[class*='upload'], [class*='Upload'], [class*='drop']")||t.anchor,o=new DataTransfer;return o.items.add(n),a.dispatchEvent(new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:o})),!0}catch(e){return console.error("[xUpload] Fill error:",e),!1}}async function U(t){if(!g)return null;try{const n=t.split("/");let e=g;for(let o=0;o<n.length-1;o++)e=await e.getDirectoryHandle(n[o]);return await(await e.getFileHandle(n[n.length-1])).getFile()}catch(n){return console.error("[xUpload] Failed to read file from handle:",n),null}}function N(t,n){const e=new DataTransfer;e.items.add(n),t.files=e.files,t.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new Event("input",{bubbles:!0}))}const b=new Map;function F(t,n){const e=n.getBoundingClientRect();e.width===0&&e.height===0||(t.style.position="fixed",t.style.top=`${e.top+(e.height-28)/2}px`,t.style.left=`${e.right+4}px`)}function j(){for(const[t,n]of b){if(!document.body.contains(n.anchor)){t.remove(),b.delete(t);continue}F(t,n.anchor)}}function A(){const t=B();for(const n of t){if(C.has(n.anchor))continue;C.add(n.anchor);const e=P(n);e.style.zIndex="2147483646",document.body.appendChild(e),F(e,n.anchor),b.set(e,n)}}A();const Y=new MutationObserver(()=>A());Y.observe(document.body,{childList:!0,subtree:!0});window.addEventListener("scroll",j,{passive:!0});window.addEventListener("resize",j,{passive:!0});
