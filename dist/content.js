(function(){"use strict";const L=[];function z(e){L.length>=500&&L.shift(),L.push(e)}function q(){return L.slice()}function N(e){const n=Date.now().toString(36),t=Math.random().toString(36).slice(2,8);return`${e}-${n}-${t}`}function u(e,n,t){if(z({ts:Date.now(),level:"info",workflowId:e,step:n,data:t}),t===void 0){console.log(`[xUpload][WF:${e}] ${n}`);return}console.log(`[xUpload][WF:${e}] ${n}`,t)}function y(e,n,t){const o=t instanceof Error?{message:t.message,stack:t.stack}:t;z({ts:Date.now(),level:"error",workflowId:e,step:n,data:o}),console.error(`[xUpload][WF:${e}] ${n}`,t)}const I="xupload-zone",S="xupload-panel",B="xupload-badge",$=new WeakSet,b=new WeakMap;let w=null,E=null,C=null,g=null,U=null;function Q(){const e=[],n=new Set;return document.querySelectorAll('input[type="file"]').forEach(t=>{if($.has(t))return;const o=V(t);!o||n.has(o)||$.has(o)||(n.add(o),e.push({zone:o,fileInput:t,context:Y(t,o),accept:t.accept||void 0}))}),e}function V(e){const n=e.closest(['[class*="upload"]','[class*="Upload"]','[class*="drop"]','[class*="Drop"]','[class*="attach"]','[class*="Attach"]','[class*="file-input"]','[class*="file-picker"]'].join(","));if(n&&D(n))return n;const t=e.closest('label, fieldset, [class*="form-group"], [class*="field"], [class*="input-group"]');if(t&&D(t))return t;let o=e.parentElement;for(let a=0;a<5&&o&&o!==document.body;a++){if(D(o))return o;o=o.parentElement}return e.parentElement}function D(e){const n=e.getBoundingClientRect();return n.width>40&&n.height>30&&n.width<window.innerWidth*.9}function Y(e,n){const t=[];if(e.id){const i=document.querySelector(`label[for="${e.id}"]`);i&&t.push(i.textContent||"")}const o=e.closest("label");o&&t.push(o.textContent||""),e.placeholder&&t.push(e.placeholder),e.title&&t.push(e.title);const a=e.getAttribute("aria-label");return a&&t.push(a),t.push((n.textContent||"").slice(0,500)),t.join(" ").trim()}function J(e){if($.add(e.zone),$.add(e.fileInput),e.zone.classList.add(I),getComputedStyle(e.zone).position==="static"&&(e.zone.style.position="relative"),!e.zone.querySelector(`.${B}`)){const n=document.createElement("span");n.className=B,n.textContent="âš¡ xUpload",e.zone.appendChild(n)}e.zone.addEventListener("mouseenter",()=>ee(e)),e.zone.addEventListener("mouseleave",()=>te())}function M(){U&&(clearTimeout(U),U=null)}function k(e=300){M(),U=setTimeout(()=>{F()},e)}function F(){E&&(E.remove(),E=null,C=null)}function ee(e){M(),!(E&&(C==null?void 0:C.zone)===e.zone)&&(g&&(clearTimeout(g),g=null),g=setTimeout(()=>{g=null,F(),ne(e)},250))}function te(){g&&(clearTimeout(g),g=null),k()}async function ne(e){var s;const n=N("recommend");u(n,"recommend.start",{contextPreview:e.context.slice(0,140),accept:e.accept||"(none)",url:window.location.href});const t=document.createElement("div");t.className=S,t.addEventListener("mouseenter",M),t.addEventListener("mouseleave",()=>k());const o=document.createElement("div");o.className="xupload-header",o.textContent="âš¡ Recommended files",t.appendChild(o);const a=document.createElement("div");a.className="xupload-loading-msg",a.textContent="Finding best filesâ€¦",t.appendChild(a);const i=H(e);t.appendChild(i),P(t,e.zone),document.body.appendChild(t),E=t,C=e;try{const c=await chrome.runtime.sendMessage({type:"GET_INDEX_COUNT"});if(!(c!=null&&c.count)||c.count===0){a.remove(),oe(t,i,e,n);return}const l=b.get(e.zone);if(l){a.remove(),A(t,i,l,e,n);return}const d=await G(e,n);b.set(e.zone,d),a.remove(),A(t,i,d,e,n)}catch(c){a.remove(),y(n,"recommend.failed",c);const l=document.createElement("div");l.className="xupload-empty",l.textContent=(s=c==null?void 0:c.message)!=null&&s.includes("Extension context invalidated")?"Extension was updated. Please refresh this page.":"Error getting recommendations.",t.insertBefore(l,i)}}function H(e){const n=document.createElement("div");n.className="xupload-panel-footer";const t=document.createElement("button");return t.type="button",t.className="xupload-default-btn",t.textContent="ðŸ“‚ Use default upload",t.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),F(),e.fileInput.click()}),n.appendChild(t),n}function A(e,n,t,o,a){if(!t.length){const c=document.createElement("div");c.className="xupload-empty",c.textContent="No matching files found.",e.insertBefore(c,n);return}const i=e.querySelector(".xupload-header");i&&(i.textContent=`âš¡ ${t.length} file${t.length>1?"s":""} recommended`);const s=document.createElement("ul");for(const c of t){const l=document.createElement("li");l.className="xupload-item";const d=document.createElement("span");d.className="xupload-icon",d.textContent=K(c.type,c.name);const m=document.createElement("div");m.className="xupload-info";const f=document.createElement("span");f.className="xupload-name",f.textContent=c.name;const h=document.createElement("span");if(h.className="xupload-path",h.textContent=c.path,m.appendChild(f),m.appendChild(h),c.historyCount&&c.historyCount>0){const r=document.createElement("span");r.className="xupload-history-badge",r.textContent=`Used ${c.historyCount}x here`,m.appendChild(r)}const p=document.createElement("span");p.className="xupload-score";const x=Math.round(c.score*100);p.textContent=`${x}%`,l.appendChild(d),l.appendChild(m),l.appendChild(p),l.title=`Click to select: ${c.name}`,l.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation(),p.textContent="...",l.classList.add("xupload-item-loading"),u(a,"recommend.file.click",{fileId:c.id,fileName:c.name,score:Math.round(c.score*100)});const v=await re(c.id,a);if(l.classList.remove("xupload-item-loading"),p.textContent=`${x}%`,!v){p.textContent="Error",p.style.color="#ea4335",u(a,"recommend.file.read_failed",{fileId:c.id});return}F(),se(o,v,c,a)}),s.appendChild(l)}e.insertBefore(s,n)}function oe(e,n,t,o){const a=document.createElement("div");a.className="xupload-empty",a.textContent="No files indexed yet.",e.insertBefore(a,n);const i=document.createElement("button");i.type="button",i.className="xupload-scan-btn",i.textContent="Select folder to scan",i.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),i.disabled=!0,i.textContent="Scanningâ€¦";const c=N("scan-inline");if(u(o,"recommend.inline_scan.requested",{scanWorkflowId:c}),await he(a,c)){a.remove(),i.remove();const d=document.createElement("div");d.className="xupload-loading-msg",d.textContent="Finding best filesâ€¦",e.insertBefore(d,n);try{const m=await G(t,o);b.set(t.zone,m),d.remove(),A(e,n,m,t,o)}catch{d.remove()}}else i.disabled=!1,i.textContent="Select folder to scan",a.textContent="Scan cancelled. Try again."}),e.insertBefore(i,n)}function P(e,n){const t=n.getBoundingClientRect();e.style.position="fixed",e.style.zIndex="2147483647";const o=t.bottom+6,a=t.left;e.style.top=`${Math.min(o,window.innerHeight-420)}px`,e.style.left=`${Math.max(4,Math.min(a,window.innerWidth-380))}px`}async function j(){return new Promise(e=>{chrome.storage.local.get("xupload_config",n=>{e(n.xupload_config||{apiKey:"",mode:"tfidf"})})})}let W=!1,_=null,T=!1;async function R(e="init"){var t;if(W||T)return;T=!0;const n=N("classify-page-content");try{const o=await j();if(u(n,"classify.auto.config.loaded",{trigger:e,mode:o.mode,hasApiKey:!!o.apiKey}),o.mode!=="vlm"&&o.mode!=="vlm_gpt"||!o.apiKey){u(n,"classify.auto.skipped",{reason:o.mode!=="vlm"?"mode_not_vlm":"missing_api_key"}),T=!1;return}if(document.visibilityState!=="visible"){u(n,"classify.auto.skipped",{reason:"tab_not_visible"}),T=!1;return}const i=(((t=document.body)==null?void 0:t.innerText)||"").replace(/\s+/g," ").slice(0,2e3),c=[document.title,window.location.href,i].filter(Boolean).join(`
`);u(n,"classify.page.request",{contextLength:c.length});const l={type:"PAGE_CLASSIFY_REQUEST",context:c,pageUrl:window.location.href,title:document.title,workflowId:n,mode:o.mode},d=await chrome.runtime.sendMessage(l);d.ok&&d.label?(_=d.label,u(n,"classify.page.done",{labelPreview:d.label.slice(0,160)}),W=!0):y(n,"classify.page.failed",d.error||"unknown_error")}catch(o){y(n,"classify.page.exception",o)}finally{T=!1}}async function G(e,n){var s,c;const t=await j();u(n,"recommend.config.loaded",{mode:t.mode,hasApiKey:!!t.apiKey});const o=_?`${e.context}
${_}`:e.context;if(_&&u(n,"recommend.context.classification_attached",{labelPreview:_.slice(0,160)}),t.apiKey&&t.mode!=="tfidf"){let l;if(t.mode==="vlm"||t.mode==="vlm_gpt")try{const f=e.zone.getBoundingClientRect(),h=await chrome.runtime.sendMessage({type:"CAPTURE_TAB"});h!=null&&h.base64&&(l=await ae(h.base64,{top:Math.max(0,f.top-150),left:Math.max(0,f.left-100),width:Math.min(800,window.innerWidth-f.left+200),height:Math.min(600,400)}))}catch(f){y(n,"service.background.CAPTURE_TAB.failed",f)}const d={type:"MATCH_REQUEST_ENHANCED",context:o,accept:e.accept,pageUrl:window.location.href,workflowId:n,mode:t.mode,screenshotBase64:l},m=await chrome.runtime.sendMessage(d);return u(n,"service.background.MATCH_REQUEST_ENHANCED.done",{responseWorkflowId:m==null?void 0:m.workflowId,resultCount:((s=m==null?void 0:m.results)==null?void 0:s.length)||0}),(m==null?void 0:m.results)||[]}const a={type:"MATCH_REQUEST",context:o,accept:e.accept,pageUrl:window.location.href,workflowId:n},i=await chrome.runtime.sendMessage(a);return u(n,"service.background.MATCH_REQUEST.done",{responseWorkflowId:i==null?void 0:i.workflowId,resultCount:((c=i==null?void 0:i.results)==null?void 0:c.length)||0}),(i==null?void 0:i.results)||[]}async function ae(e,n){const t=new Image;await new Promise((m,f)=>{t.onload=()=>m(),t.onerror=f,t.src=`data:image/png;base64,${e}`});const o=window.devicePixelRatio||1,a=n.left*o,i=n.top*o,s=n.width*o,c=n.height*o,l=document.createElement("canvas");return l.width=s,l.height=c,l.getContext("2d").drawImage(t,a,i,s,c,0,0,s,c),l.toDataURL("image/png").replace(/^data:image\/\w+;base64,/,"")}const ie=["jpg","jpeg","png","gif","webp","bmp","svg"],O=["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"];function K(e,n){var o;const t=((o=n.split(".").pop())==null?void 0:o.toLowerCase())||"";return t==="pdf"||e==="application/pdf"?"ðŸ“„":["doc","docx"].includes(t)?"ðŸ“ƒ":["jpg","jpeg","png","gif","webp"].includes(t)?"ðŸ–¼ï¸":["xls","xlsx","csv"].includes(t)?"ðŸ“Š":"ðŸ“"}function ce(e){var n;return((n=e.split(".").pop())==null?void 0:n.toLowerCase())||""}function se(e,n,t,o){document.querySelectorAll(`.${S}`).forEach(r=>r.remove()),E=null,C=null;const a=document.createElement("div");a.className=S+" xupload-preview";const i=document.createElement("div");i.className="xupload-header";const s=document.createElement("span");s.textContent=K(t.type,t.name),s.style.marginRight="6px";const c=document.createElement("span");c.textContent=t.name,i.appendChild(s),i.appendChild(c),a.appendChild(i);const l=document.createElement("div");l.className="xupload-preview-content",a.appendChild(l);const d=ce(n.name),m=URL.createObjectURL(n);if(ie.includes(d)){const r=document.createElement("img");r.src=m,r.className="xupload-preview-img",r.alt=n.name,l.appendChild(r)}else if(d==="pdf"){const r=document.createElement("embed");r.src=m,r.type="application/pdf",r.className="xupload-preview-pdf",l.appendChild(r)}else if(O.includes(d)){const r=document.createElement("pre");r.className="xupload-preview-text",n.text().then(v=>{r.textContent=v.slice(0,5e3),v.length>5e3&&(r.textContent+=`

... (truncated)`)}),l.appendChild(r)}else{const r=document.createElement("div");r.className="xupload-preview-info",r.textContent=`${n.name} (${(n.size/1024).toFixed(1)} KB)`,l.appendChild(r)}const f=document.createElement("div");f.className="xupload-preview-actions";const h=document.createElement("button");h.type="button",h.className="xupload-preview-btn xupload-preview-back",h.textContent="Back",h.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),URL.revokeObjectURL(m),a.remove(),le(e,o)});const p=document.createElement("button");p.type="button",p.className="xupload-preview-btn xupload-preview-use",p.textContent="Use this file",p.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation(),p.disabled=!0,p.textContent="Fillingâ€¦",u(o,"recommend.fill.start",{fileId:t.id,fileName:t.name,path:t.path});const v=me(e,n);if(URL.revokeObjectURL(m),v){u(o,"recommend.fill.done",{method:"setFileInput_or_drop"}),p.textContent="âœ“ Done",p.classList.add("xupload-preview-done"),setTimeout(()=>a.remove(),600);try{chrome.runtime.sendMessage({type:"TRACK_UPLOAD",entry:{fileId:t.id,fileName:t.name,fileType:t.type,websiteHost:new URL(window.location.href).hostname,pageUrl:window.location.href,pageTitle:document.title,uploadContext:e.context.slice(0,200),timestamp:Date.now()}},()=>void chrome.runtime.lastError),chrome.runtime.sendMessage({type:"SAVE_USED_PATH",host:new URL(window.location.href).hostname,filePath:t.path},()=>void chrome.runtime.lastError),u(o,"recommend.memory.saved",{host:new URL(window.location.href).hostname,filePath:t.path})}catch{}b.delete(e.zone)}else u(o,"recommend.fill.failed"),p.textContent="Error",p.disabled=!1}),f.appendChild(h),f.appendChild(p),a.appendChild(f);const x=r=>{a.contains(r.target)||(URL.revokeObjectURL(m),a.remove(),document.removeEventListener("click",x))};setTimeout(()=>document.addEventListener("click",x),0),P(a,e.zone),document.body.appendChild(a)}function le(e,n){const t=b.get(e.zone);if(!t)return;const o=document.createElement("div");o.className=S;const a=document.createElement("div");a.className="xupload-header",a.textContent=`âš¡ ${t.length} file${t.length>1?"s":""} recommended`,o.appendChild(a);const i=H(e);o.appendChild(i),A(o,i,t,e,n),P(o,e.zone),document.body.appendChild(o);const s=c=>{o.contains(c.target)||(o.remove(),document.removeEventListener("click",s))};setTimeout(()=>document.addEventListener("click",s),0)}async function re(e,n){u(n,"service.content.readFileFromHandle.start",{fileId:e});let t=await de(e);if(t)return u(n,"service.content.readFileFromHandle.done",{source:"in_memory_handle"}),t;try{u(n,"service.background.GET_FILE.start",{fileId:e});const o=await chrome.runtime.sendMessage({type:"GET_FILE",id:e});if(o&&!o.error&&o.base64){const a=atob(o.base64),i=new Uint8Array(a.length);for(let s=0;s<a.length;s++)i[s]=a.charCodeAt(s);return u(n,"service.background.GET_FILE.done",{source:"background_handle"}),new File([i],o.name,{type:o.type,lastModified:o.lastModified})}u(n,"service.background.GET_FILE.empty",(o==null?void 0:o.error)||"no_data")}catch(o){y(n,"service.background.GET_FILE.failed",o)}return u(n,"service.content.read_file.failed",{reason:"missing_or_expired_directory_permission",action:"rescan_from_popup_if_needed"}),null}async function de(e){if(!w)return null;try{const n=e.split("/");let t=w;for(let a=0;a<n.length-1;a++)t=await t.getDirectoryHandle(n[a]);return await(await t.getFileHandle(n[n.length-1])).getFile()}catch(n){return console.error("[xUpload] Failed to read file from handle:",n),null}}function me(e,n){try{return ue(e.fileInput,n),!0}catch{try{const t=new DataTransfer;return t.items.add(n),e.zone.dispatchEvent(new DragEvent("drop",{bubbles:!0,cancelable:!0,dataTransfer:t})),!0}catch(t){return console.error("[xUpload] Fill error:",t),!1}}}function ue(e,n){const t=new DataTransfer;t.items.add(n),e.files=t.files,e.dispatchEvent(new Event("change",{bubbles:!0})),e.dispatchEvent(new Event("input",{bubbles:!0}))}async function X(e,n){const t=[];for await(const o of e.values()){const a=n?`${n}/${o.name}`:o.name;if(o.kind==="file")t.push({fileHandle:o,path:a});else if(o.kind==="directory"&&!o.name.startsWith(".")){const i=await X(o,a);t.push(...i)}}return t}function pe(e){var o;const n=((o=e.split(".").pop())==null?void 0:o.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[n]||"application/octet-stream"}async function fe(e,n){var i;const t=e.name.replace(/[._-]/g," "),o=((i=e.name.split(".").pop())==null?void 0:i.toLowerCase())||"",a=n?n.replace(/[/\\._-]/g," "):t;if(O.includes(o))try{const s=await e.text();return`${a} ${s.slice(0,2e3)}`}catch{return a}if(o==="pdf")try{const s=await e.arrayBuffer(),c=new Uint8Array(s);let l="";const d=Math.min(c.length,5e5);for(let x=0;x<d;x++)l+=String.fromCharCode(c[x]);const m=[],f=/BT\s([\s\S]*?)ET/g;let h;for(;(h=f.exec(l))!==null;){const x=/\(([^)]*)\)/g;let r;for(;(r=x.exec(h[1]))!==null;)m.push(r[1])}const p=m.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim();return p.length>10?`${a} ${p.slice(0,2e3)}`:`${a} pdf document`}catch{return`${a} pdf document`}return["jpg","jpeg","png","gif","webp","bmp","svg","tiff","heic"].includes(o)?`${a} image photo picture`:["doc","docx"].includes(o)?`${a} document word`:["xls","xlsx"].includes(o)?`${a} spreadsheet excel`:["ppt","pptx"].includes(o)?`${a} presentation slides`:a}async function he(e,n=N("scan-inline")){u(n,"scan.inline.start");try{u(n,"service.filesystem.showDirectoryPicker.start"),w=await window.showDirectoryPicker({mode:"read"}),u(n,"service.filesystem.showDirectoryPicker.done")}catch(s){return s.name==="AbortError"||y(n,"scan.inline.showDirectoryPicker.failed",s),!1}if(!w)return!1;e&&(e.textContent="Scanning filesâ€¦");const t=await X(w,"");u(n,"service.filesystem.collectFiles.done",{discoveredFiles:t.length}),e&&(e.textContent=`Found ${t.length} files. Readingâ€¦`);const o=[];let a=0;for(let s=0;s<t.length;s++){const{fileHandle:c,path:l}=t[s];try{const d=await c.getFile(),m=await fe(d,l);o.push({path:l,name:d.name,type:d.type||pe(d.name),size:d.size,lastModified:d.lastModified,text:m})}catch{a++}s%10===0&&e&&(e.textContent=`Reading filesâ€¦ ${s+1}/${t.length}`)}e&&(e.textContent="Building indexâ€¦"),u(n,"scan.inline.read.done",{processedFiles:o.length,unreadable:a});const i=await chrome.runtime.sendMessage({type:"BUILD_INDEX",files:o,workflowId:n});return u(n,"service.background.BUILD_INDEX.done",i),e&&(e.textContent=`Done! ${(i==null?void 0:i.count)||o.length} files indexed.`),u(n,"scan.inline.done",{indexedFiles:(i==null?void 0:i.count)||o.length}),!0}function Z(){const e=Q();for(const n of e)J(n)}Z(),R(),new MutationObserver(()=>Z()).observe(document.body,{childList:!0,subtree:!0}),chrome.storage.onChanged.addListener((e,n)=>{n!=="local"||!e.xupload_config||R("config")}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&R("visibility")}),chrome.runtime.onMessage.addListener((e,n,t)=>{var o;if(e.type==="GET_CONTENT_LOGS")return t({source:"content",url:window.location.href,logs:q()}),!0;if(e.type==="GET_PAGE_CONTEXT"){const i=(((o=document.body)==null?void 0:o.innerText)||"").replace(/\s+/g," ").slice(0,2e3);return t({title:document.title,url:window.location.href,textPreview:i}),!0}})})();
