import{g as w,a as v,i,b as l,c as D,t as d,v as E,s as _,d as k,e as C,f as N,u as S,h as B,j as A,k as V,l as H,m as L}from"./vectordb.js";async function g(){if(l()>0)return;const e=await v();if(e){i(e),console.log("[xUpload] Vocab loaded from IndexedDB:",l(),"terms");return}return new Promise(r=>{chrome.storage.local.get("vocab",o=>{o.vocab?(i(o.vocab),console.log("[xUpload] Vocab loaded from chrome.storage:",l(),"terms"),A(o.vocab).catch(()=>{})):console.warn("[xUpload] No vocab found."),r()})})}g();chrome.runtime.onMessage.addListener((e,r,o)=>{if(e.type==="MATCH_REQUEST")return z(e).then(o),!0;if(e.type==="GET_FILE")return O(e.id).then(o),!0;if(e.type==="GET_INDEX_COUNT")return w().then(n=>o({count:n})),!0;if(e.type==="BUILD_INDEX")return F(e.files).then(o),!0;if(e.type==="VOCAB_UPDATED")return(async()=>{const n=await v();n?(i(n),console.log("[xUpload] Vocab reloaded from IndexedDB:",l(),"terms")):chrome.storage.local.get("vocab",a=>{a.vocab&&(i(a.vocab),console.log("[xUpload] Vocab reloaded from chrome.storage:",l(),"terms"))}),o({ok:!0})})(),!0;if(e.type==="TRACK_UPLOAD"){const n=e.entry;return D(n).then(()=>{o({ok:!0})}).catch(a=>{console.error("[xUpload] Failed to track upload:",a),o({ok:!1})}),!0}if(e.type==="RESCAN_CONFIG_UPDATED")return u().then(()=>o({ok:!0})),!0});function P(e,r){const o=d(e.replace(/[/\\._-]/g," ")),n=new Set(d(r));if(o.length===0||n.size===0)return 0;let a=0;for(const c of o)n.has(c)&&a++;return a/o.length}async function z(e){await g(),console.log("[xUpload] MATCH context:",e.context.slice(0,100));const r=d(e.context),o=E(r);if(o.length===0)return console.warn("[xUpload] Empty vector â€” vocab size:",l()),{type:"MATCH_RESPONSE",results:[]};const n=await _(o,15,e.accept);let a=[];if(e.pageUrl)try{const t=new URL(e.pageUrl).hostname;a=await k(t)}catch{}const c=new Map;for(const t of a){const s=c.get(t.fileId);s?(s.count++,s.lastTs=Math.max(s.lastTs,t.timestamp)):c.set(t.fileId,{count:1,lastTs:t.timestamp})}const p=24*60*60*1e3,T=Date.now(),y=n.map(t=>{const s=t.score;let h=0,U=0;const m=c.get(t.record.id);if(m){U=m.count;const M=(T-m.lastTs)/p;h=Math.max(.1,1-M/90)}const b=P(t.record.path,e.context),I=h>0?s*.5+h*.35+b*.15:s*.75+b*.25;return{...t,score:I,historyCount:U}});y.sort((t,s)=>s.score-t.score);const x=y.slice(0,5).filter(t=>t.score>0);return console.log("[xUpload] Results:",x.map(t=>`${t.record.name} (${Math.round(t.score*100)}%)`)),{type:"MATCH_RESPONSE",results:x.map(t=>({id:t.record.id,name:t.record.name,path:t.record.path,type:t.record.type,score:t.score,historyCount:t.historyCount}))}}async function F(e){console.log("[xUpload] BUILD_INDEX:",e.length,"files");const r=e.map(a=>d(a.text));C(r),await N();for(let a=0;a<e.length;a++){const c=e[a],p=E(r[a]);await S({id:c.path,name:c.name,path:c.path,type:c.type,size:c.size,lastModified:c.lastModified,vector:p,textPreview:c.text.slice(0,100)})}const o=B();await A(o),await new Promise(a=>{chrome.storage.local.set({vocab:o},a)});const n=await w();return console.log("[xUpload] Index built:",n,"files"),{ok:!0,count:n}}async function O(e){console.log("[xUpload] GET_FILE:",e);const r=await V(e);return r?(console.log("[xUpload] Sending:",r.name),r):{error:"Cannot read file. Please re-scan the folder from the xUpload popup."}}const f="xupload-rescan";async function u(){await chrome.alarms.clear(f);const e=await H();e.autoRescanEnabled&&e.rescanIntervalMin>0?(chrome.alarms.create(f,{periodInMinutes:e.rescanIntervalMin}),console.log(`[xUpload] Rescan alarm set: every ${e.rescanIntervalMin} min`)):console.log("[xUpload] Auto-rescan disabled")}chrome.alarms.onAlarm.addListener(async e=>{if(e.name!==f)return;console.log("[xUpload] Auto-rescan alarm fired");const r=await L();if(!r){console.log("[xUpload] No directory handle, skipping auto-rescan");return}try{if(await r.queryPermission({mode:"read"})!=="granted"){console.log("[xUpload] Directory permission not granted, skipping auto-rescan"),chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#ea4335"});return}chrome.action.setBadgeText({text:""}),console.log("[xUpload] Auto-rescan: directory handle valid, notifying tabs")}catch(o){console.error("[xUpload] Auto-rescan error:",o)}});chrome.runtime.onStartup.addListener(()=>{console.log("[xUpload] Extension started"),g(),u()});chrome.runtime.onInstalled.addListener(()=>{console.log("[xUpload] Extension installed/updated"),u()});u();
