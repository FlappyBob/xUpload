import{l as te,g as $,a as R,i as P,b as E,c as ae,s as oe,d as ne,e as V,f as s,t as F,v as W,h as re,r as g,j as ce,k as j,m as K,n as x,o as se,p as ie,q as le,u as de,w as he,x as Y,y as pe,z as ue,A as me,B,C as ge}from"./workflow.js";const fe="https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",Q="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",ye="https://api.openai.com/v1/responses";async function J(e,t){const a=await fetch(`${fe}?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:e.slice(0,8e3)}]}})});if(!a.ok){const i=await a.text();throw new Error(`Gemini embedding error ${a.status}: ${i}`)}return(await a.json()).embedding.values}async function be(e,t,a=10,o){const i=[];for(let c=0;c<e.length;c+=a){const h=e.slice(c,c+a),u=await Promise.all(h.map(l=>J(l,t)));i.push(...u),o==null||o(Math.min(c+a,e.length),e.length),c+a<e.length&&await new Promise(l=>setTimeout(l,200))}return i}async function ve(e,t,a){var h,u,l,d,p;const o=await fetch(`${Q}?key=${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inlineData:{mimeType:"image/png",data:e}},{text:`You are analyzing a webpage screenshot showing a file upload area. The surrounding text context is: "${t.slice(0,500)}"

Describe in 2-3 sentences what type of file this upload field is asking the user to provide. Be specific about the document type (e.g., passport, resume, transcript, photo ID, tax form, etc.). Focus on keywords that would help match against file names and content.`}]}],generationConfig:{maxOutputTokens:200,temperature:.2}})});if(!o.ok){const f=await o.text();throw new Error(`Gemini VLM error ${o.status}: ${f}`)}return((p=(d=(l=(u=(h=(await o.json()).candidates)==null?void 0:h[0])==null?void 0:u.content)==null?void 0:l.parts)==null?void 0:d[0])==null?void 0:p.text)||""}async function we(e,t,a){var h,u,l,d,p;const o=await fetch(`${Q}?key=${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inlineData:{mimeType:"image/png",data:e}},{text:["You are classifying what type of website this is based on a screenshot and page context.","Return a short label and a one-line rationale.","Choose the closest label from: job application, visa/immigration, university application, banking/finance, healthcare, government services, e-commerce checkout, file upload portal, AI chat, general form, other.",`Context: "${t.slice(0,1200)}"`].join(`
`)}]}],generationConfig:{maxOutputTokens:120,temperature:.2}})});if(!o.ok){const f=await o.text();throw new Error(`Gemini VLM error ${o.status}: ${f}`)}return((p=(d=(l=(u=(h=(await o.json()).candidates)==null?void 0:h[0])==null?void 0:u.content)==null?void 0:l.parts)==null?void 0:d[0])==null?void 0:p.text)||""}async function X(e,t,a){var h,u,l,d;const o=await fetch(ye,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:"gpt-4o-mini",input:[{role:"user",content:[{type:"input_text",text:["You are classifying what type of website this is based on a screenshot and page context.","Return a short label and a one-line rationale.","Choose the closest label from: job application, visa/immigration, university application, banking/finance, healthcare, government services, e-commerce checkout, file upload portal, AI chat, general form, other.",`Context: "${t.slice(0,1200)}"`].join(`
`)},{type:"input_image",image_url:`data:image/png;base64,${e}`}]}],max_output_tokens:120,temperature:.2})});if(!o.ok){const p=await o.text();throw new Error(`ChatGPT VLM error ${o.status}: ${p}`)}return((d=(l=(u=(h=(await o.json()).output)==null?void 0:h[0])==null?void 0:u.content)==null?void 0:l[0])==null?void 0:d.text)||""}async function G(){if(E()>0)return;const e=await R();if(e){P(e),console.log("[xUpload] Vocab loaded from IndexedDB:",E(),"terms");return}return new Promise(t=>{chrome.storage.local.get("vocab",a=>{a.vocab?(P(a.vocab),console.log("[xUpload] Vocab loaded from chrome.storage:",E(),"terms"),Y(a.vocab).catch(()=>{})):console.warn("[xUpload] No vocab found."),t()})})}G();const I="xupload_debug_logs";(function(){chrome.storage.local.get(I,t=>{const a=t[I];Array.isArray(a)&&a.length>0&&te(a)}),ge(t=>{chrome.storage.local.set({[I]:t})})})();chrome.runtime.onMessage.addListener((e,t,a)=>{if(e.type==="MATCH_REQUEST")return U(e).then(a),!0;if(e.type==="GET_FILE")return Ee(e.id).then(a),!0;if(e.type==="GET_INDEX_COUNT")return $().then(o=>a({count:o})),!0;if(e.type==="BUILD_INDEX")return _e(e.files,e.workflowId).then(a),!0;if(e.type==="VOCAB_UPDATED")return(async()=>{const o=await R();o?(P(o),console.log("[xUpload] Vocab reloaded from IndexedDB:",E(),"terms")):chrome.storage.local.get("vocab",i=>{i.vocab&&(P(i.vocab),console.log("[xUpload] Vocab reloaded from chrome.storage:",E(),"terms"))}),a({ok:!0})})(),!0;if(e.type==="TRACK_UPLOAD"){const o=e.entry;return ae(o).then(()=>{a({ok:!0})}).catch(i=>{console.error("[xUpload] Failed to track upload:",i),a({ok:!1})}),!0}if(e.type==="MATCH_REQUEST_ENHANCED")return xe(e).then(a),!0;if(e.type==="CAPTURE_TAB")return chrome.tabs.captureVisibleTab({format:"png"},o=>{if(chrome.runtime.lastError){a({error:chrome.runtime.lastError.message});return}const i=(o==null?void 0:o.replace(/^data:image\/\w+;base64,/,""))||"";a({base64:i})}),!0;if(e.type==="SAVE_USED_PATH")return oe(e.host,e.filePath).then(()=>a({ok:!0})).catch(()=>a({ok:!1})),!0;if(e.type==="RESCAN_CONFIG_UPDATED")return L().then(()=>a({ok:!0})),!0;if(e.type==="PAGE_CLASSIFY_REQUEST")return Se(e).then(a),!0;if(e.type==="GET_DEBUG_LOGS")return(async()=>{const o=await $();a({source:"background",logs:ne(),meta:{indexedFiles:o,vocabSize:E(),timestamp:Date.now()}})})(),!0});function Z(e,t){const a=new Set(B(e.replace(/[/\\._-]/g," "))),o=new Set(B(t));if(a.size===0||o.size===0)return 0;let i=0;for(const h of a)o.has(h)&&i++;const c=Math.min(a.size,o.size);return i/c}function q(e,t){const a=new Set(B(e)),o=new Set(B(t));if(a.size===0||o.size===0)return 0;let i=0;for(const h of o)a.has(h)&&i++;const c=Math.min(a.size,o.size);return i/c}async function U(e){const t=e.workflowId||V("match-bg"),a=new Set;s(t,"match.start",{contextPreview:e.context.slice(0,140),accept:e.accept||"(none)",pageUrl:e.pageUrl||"(none)"});try{a.add("background.ensureVocab"),await G();const o=F(e.context),i=W(o);s(t,"service.tfidf.vectorize",{queryTokenCount:o.length,queryVectorSize:i.length}),a.add("vectordb.search");const c=i.length>0?await re(i,15,e.accept):[],h=c.length>0?Math.max(...c.map(n=>n.score)):0,u=h>.05;s(t,"service.vectordb.search.done",{candidateCount:c.length,maxTfidf:g(h),tfidfUseful:u});let l=c;u||(a.add("vectordb.getAll"),l=(await ce()).map(m=>({record:m,score:0})),s(t,"ranking.fallback.path_content",{reason:"tfidf_low_signal",maxTfidf:g(h),fullCandidateCount:l.length}));let d="";if(e.pageUrl)try{d=new URL(e.pageUrl).hostname}catch{d=""}let p=[],f=[];d&&(a.add("vectordb.getHistoryByHost"),a.add("vectordb.getUsedPaths"),p=await j(d),f=await K(d),s(t,"service.history.lookup.done",{host:d,historyRows:p.length,memorizedPaths:f.length}));const O=new Set(f),C=new Map;for(const n of p){const m=C.get(n.fileId);m?(m.count++,m.lastTs=Math.max(m.lastTs,n.timestamp)):C.set(n.fileId,{count:1,lastTs:n.timestamp})}const N=24*60*60*1e3,A=Date.now(),b=l.map(n=>{const m=n.score;let w=0,S=0;const _=C.get(n.record.id);if(_){S=_.count;const ee=(A-_.lastTs)/N;w=Math.max(.1,1-ee/90)}const T=Z(n.record.path,e.context),k=q(n.record.textPreview,e.context),M=O.has(n.record.path)?1:0,y=w>0,v=u?y?{tfidf:.42,history:.28,path:.14,content:.08,pathMemory:.08}:{tfidf:.56,history:0,path:.22,content:.14,pathMemory:.08}:y?{tfidf:0,history:.36,path:.3,content:.2,pathMemory:.14}:{tfidf:0,history:0,path:.44,content:.42,pathMemory:.14},D=m*v.tfidf+w*v.history+T*v.path+k*v.content+M*v.pathMemory;return{...n,score:D,historyCount:S,debug:{tfidfScore:m,historyBoost:w,pathNameScore:T,contentOverlap:k,pathMemoryBoost:M,weights:v}}});b.sort((n,m)=>m.score-n.score);const r=b.slice(0,5).filter(n=>n.score>0);return s(t,"ranking.breakdown.top_candidates",b.slice(0,10).map((n,m)=>({rank:m+1,file:n.record.name,path:n.record.path,finalScore:g(n.score),tfidfScore:g(n.debug.tfidfScore),historyBoost:g(n.debug.historyBoost),pathNameScore:g(n.debug.pathNameScore),contentOverlap:g(n.debug.contentOverlap),pathMemoryBoost:n.debug.pathMemoryBoost,historyCount:n.historyCount,weights:n.debug.weights}))),s(t,"match.services_called",Array.from(a)),s(t,"match.done",{candidateCount:b.length,returnedCount:r.length,results:r.map(n=>`${n.record.name} (${Math.round(n.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:r.map(n=>({id:n.record.id,name:n.record.name,path:n.record.path,type:n.record.type,score:n.score,historyCount:n.historyCount}))}}catch(o){throw x(t,"match.failed",o),o}}async function H(){return new Promise(e=>{chrome.storage.local.get("xupload_config",t=>{e(t.xupload_config||{apiKey:"",mode:"tfidf"})})})}async function xe(e){const t=e.workflowId||V("match-enhanced-bg"),a=new Set(["chrome.storage.local.get:xupload_config"]);s(t,"match.enhanced.start",{mode:e.mode,hasScreenshot:!!e.screenshotBase64,contextPreview:e.context.slice(0,140),accept:e.accept||"(none)"});const o=await H();if(!o.apiKey)return s(t,"match.enhanced.fallback",{reason:"missing_api_key"}),U({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let i=e.context;if((e.mode==="vlm"||e.mode==="vlm_gpt")&&e.screenshotBase64)try{if(e.mode==="vlm_gpt"){a.add("chatgpt.describeWithVLM"),s(t,"service.chatgpt.describeWithVLM.start");const c=await X(e.screenshotBase64,e.context,o.apiKey);s(t,"service.chatgpt.describeWithVLM.done",{descriptionPreview:c.slice(0,160)}),i=`${c} ${e.context}`}else{a.add("gemini.describeWithVLM"),s(t,"service.gemini.describeWithVLM.start");const c=await ve(e.screenshotBase64,e.context,o.apiKey);s(t,"service.gemini.describeWithVLM.done",{descriptionPreview:c.slice(0,160)}),i=`${c} ${e.context}`}}catch(c){x(t,e.mode==="vlm_gpt"?"service.chatgpt.describeWithVLM.failed":"service.gemini.describeWithVLM.failed",c)}try{a.add("gemini.getEmbedding"),s(t,"service.gemini.getEmbedding.start");const c=await J(i,o.apiKey);a.add("vectordb.denseSearch");const h=await se(c,5,e.accept);if(s(t,"service.vectordb.denseSearch.done",{queryVectorSize:c.length,candidateCount:h.length}),h.length===0)return s(t,"match.enhanced.fallback",{reason:"dense_no_results"}),U({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let u=[],l=[],d="";if(e.pageUrl)try{d=new URL(e.pageUrl).hostname}catch{}if(d){try{a.add("vectordb.getHistoryByHost"),u=await j(d)}catch{}try{a.add("vectordb.getUsedPaths"),l=await K(d)}catch{}}const p=new Map;for(const r of u){const n=p.get(r.fileId);n?p.set(r.fileId,{count:n.count+1,lastTs:Math.max(n.lastTs,r.timestamp)}):p.set(r.fileId,{count:1,lastTs:r.timestamp})}const f=new Set(l),O=24*60*60*1e3,C=Date.now(),N=/resume|cv|简历|job application/i.test(e.context)||/resume|cv|简历|job application/i.test(e.pageUrl||""),A=h.map(r=>{const n=r.score;let m=0,w=0;const S=p.get(r.record.id);if(S){w=S.count;const D=(C-S.lastTs)/O;m=Math.max(.1,1-D/90)}const _=Z(r.record.path,e.context),T=q(r.record.textPreview,e.context),k=f.has(r.record.path)?1:0,M=N&&/resume|cv|简历/i.test(r.record.path)?1:0,y={dense:.35,history:.1,path:.16,content:.06,pathMemory:.02,resume:.31},v=n*y.dense+m*y.history+_*y.path+T*y.content+k*y.pathMemory+M*y.resume;return{...r,score:v,historyCount:w,debug:{denseScore:n,historyBoost:m,pathNameScore:_,contentOverlap:T,pathMemoryBoost:k,resumeBoost:M,weights:y}}});A.sort((r,n)=>n.score-r.score);const b=A.slice(0,5);return s(t,"match.enhanced.ranking.top_candidates",b.map((r,n)=>({rank:n+1,file:r.record.name,path:r.record.path,finalScore:g(r.score),denseScore:g(r.debug.denseScore),historyBoost:g(r.debug.historyBoost),pathNameScore:g(r.debug.pathNameScore),contentOverlap:g(r.debug.contentOverlap),pathMemoryBoost:r.debug.pathMemoryBoost,resumeBoost:r.debug.resumeBoost,historyCount:r.historyCount,weights:r.debug.weights}))),s(t,"match.enhanced.services_called",Array.from(a)),s(t,"match.enhanced.done",{returnedCount:b.length,top:b.map(r=>`${r.record.name} (${Math.round(r.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:b.map(r=>({id:r.record.id,name:r.record.name,path:r.record.path,type:r.record.type,score:r.score,historyCount:r.historyCount}))}}catch(c){return x(t,"match.enhanced.failed",c),U({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t})}}async function Se(e){const t=e.workflowId||V("classify-page-bg");s(t,"classify.page.start",{hasScreenshot:!!e.screenshotBase64,contextPreview:e.context.slice(0,140),pageUrl:e.pageUrl});try{const a=await H();if(!a.apiKey)return x(t,"classify.page.missing_api_key",null),{type:"PAGE_CLASSIFY_RESPONSE",ok:!1,workflowId:t,error:"missing_api_key"};let o=e.screenshotBase64;if(o||(s(t,"service.chrome.captureVisibleTab.start"),o=(await new Promise((h,u)=>{const l=e.windowId??chrome.windows.WINDOW_ID_CURRENT;chrome.tabs.captureVisibleTab(l,{format:"png"},d=>{var p;if(chrome.runtime.lastError||!d){u(new Error(((p=chrome.runtime.lastError)==null?void 0:p.message)||"capture_failed"));return}h(d)})})).replace(/^data:image\/\w+;base64,/,""),s(t,"service.chrome.captureVisibleTab.done")),e.mode==="vlm_gpt"){s(t,"service.chatgpt.page_classify.start");const c=await X(o,e.context,a.apiKey);return s(t,"service.chatgpt.page_classify.done",{labelPreview:c.slice(0,160)}),{type:"PAGE_CLASSIFY_RESPONSE",ok:!0,workflowId:t,label:c}}s(t,"service.gemini.page_classify.start");const i=await we(o,e.context,a.apiKey);return s(t,"service.gemini.page_classify.done",{labelPreview:i.slice(0,160)}),{type:"PAGE_CLASSIFY_RESPONSE",ok:!0,workflowId:t,label:i}}catch(a){return x(t,"classify.page.failed",a),{type:"PAGE_CLASSIFY_RESPONSE",ok:!1,workflowId:t,error:"classify_failed"}}}async function _e(e,t=V("scan-bg")){const a=new Set(["embeddings.tokenize","embeddings.buildVocabulary","vectordb.clearAll","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","vectordb.getCount"]);s(t,"scan.background.start",{fileCount:e.length,mode:"full"});try{const o=e.map(l=>F(l.text));ie(o),s(t,"scan.phase.tfidf.done",{tokenizedFiles:o.length}),await le(),s(t,"service.vectordb.clearAll.done");const i=await H();a.add("chrome.storage.local.get:xupload_config");let c=new Array(e.length).fill(void 0);if(i.apiKey&&i.mode!=="tfidf"){a.add("gemini.batchEmbed"),s(t,"service.gemini.batchEmbed.start",{fileCount:e.length,mode:i.mode});try{const l=e.map(p=>p.text.slice(0,2e3)),d=await be(l,i.apiKey,10,(p,f)=>{s(t,"service.gemini.batchEmbed.progress",{done:p,total:f})});c=d,s(t,"service.gemini.batchEmbed.done",{vectorCount:d.length})}catch(l){x(t,"service.gemini.batchEmbed.failed",l)}}for(let l=0;l<e.length;l++){const d=e[l],p=W(o[l]);await de({id:d.path,name:d.name,path:d.path,type:d.type,size:d.size,lastModified:d.lastModified,vector:p,denseVector:c[l],textPreview:d.text.slice(0,500)})}s(t,"service.vectordb.upsert.done",{upserted:e.length});const h=he();await Y(h),await new Promise(l=>{chrome.storage.local.set({vocab:h},l)}),s(t,"service.vocab.persist.done",{termCount:h.terms.length});const u=await $();return s(t,"scan.background.services_called",Array.from(a)),s(t,"scan.background.done",{indexedCount:u}),{ok:!0,count:u,workflowId:t}}catch(o){return x(t,"scan.background.failed",o),{ok:!1,error:(o==null?void 0:o.message)||String(o),workflowId:t}}}async function Ee(e){console.log("[xUpload] GET_FILE:",e);const t=await pe(e);return t?(console.log("[xUpload] Sending:",t.name),t):{error:"Cannot read file. Please re-scan the folder from the xUpload popup."}}const z="xupload-rescan";async function L(){await chrome.alarms.clear(z);const e=await ue();e.autoRescanEnabled&&e.rescanIntervalMin>0?(chrome.alarms.create(z,{periodInMinutes:e.rescanIntervalMin}),console.log(`[xUpload] Rescan alarm set: every ${e.rescanIntervalMin} min`)):console.log("[xUpload] Auto-rescan disabled")}chrome.alarms.onAlarm.addListener(async e=>{if(e.name!==z)return;console.log("[xUpload] Auto-rescan alarm fired");const t=await me();if(!t){console.log("[xUpload] No directory handle, skipping auto-rescan");return}try{if(await t.queryPermission({mode:"read"})!=="granted"){console.log("[xUpload] Directory permission not granted, skipping auto-rescan"),chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#ea4335"});return}chrome.action.setBadgeText({text:""}),console.log("[xUpload] Auto-rescan: directory handle valid, notifying tabs")}catch(a){console.error("[xUpload] Auto-rescan error:",a)}});chrome.runtime.onStartup.addListener(()=>{console.log("[xUpload] Extension started"),G(),L()});chrome.runtime.onInstalled.addListener(()=>{console.log("[xUpload] Extension installed/updated"),L()});L();
