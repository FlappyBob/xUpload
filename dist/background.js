import{l as oe,g as z,a as j,i as L,b as M,c as ne,s as se,d as re,e as O,f as i,t as W,v as F,h as ce,r as b,j as ie,k as K,m as Y,n as T,o as de,p as le,q as he,u as pe,w as me,x as Q,y as ue,z as ge,A as fe,B as V,C as ye}from"./workflow.js";const be="https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:embedContent",J="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",ve="https://api.openai.com/v1/responses",we="https://api.openai.com/v1/embeddings";async function X(e,t){const a=await fetch(`${be}?key=${t}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:e.slice(0,8e3)}]}})});if(!a.ok){const c=await a.text();throw new Error(`Gemini embedding error ${a.status}: ${c}`)}return(await a.json()).embedding.values}async function xe(e,t){var c,s;const a=await fetch(we,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:"text-embedding-3-small",input:e.slice(0,8e3)})});if(!a.ok){const h=await a.text();throw new Error(`ChatGPT embedding error ${a.status}: ${h}`)}return((s=(c=(await a.json()).data)==null?void 0:c[0])==null?void 0:s.embedding)||[]}async function Ee(e,t,a=10,o){const c=[];for(let s=0;s<e.length;s+=a){const h=e.slice(s,s+a),m=await Promise.all(h.map(d=>X(d,t)));c.push(...m),o==null||o(Math.min(s+a,e.length),e.length),s+a<e.length&&await new Promise(d=>setTimeout(d,200))}return c}async function Se(e,t,a){var h,m,d,l,p;const o=await fetch(`${J}?key=${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inlineData:{mimeType:"image/png",data:e}},{text:`You are analyzing a webpage screenshot showing a file upload area. The surrounding text context is: "${t.slice(0,500)}"

Describe in 2-3 sentences what type of file this upload field is asking the user to provide. Be specific about the document type (e.g., passport, resume, transcript, photo ID, tax form, etc.). Focus on keywords that would help match against file names and content.`}]}],generationConfig:{maxOutputTokens:200,temperature:.2}})});if(!o.ok){const v=await o.text();throw new Error(`Gemini VLM error ${o.status}: ${v}`)}return((p=(l=(d=(m=(h=(await o.json()).candidates)==null?void 0:h[0])==null?void 0:m.content)==null?void 0:d.parts)==null?void 0:l[0])==null?void 0:p.text)||""}async function _e(e,t,a){var h,m,d,l,p;const o=await fetch(`${J}?key=${a}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inlineData:{mimeType:"image/png",data:e}},{text:["You are classifying what type of website this is based on a screenshot and page context.","Return a short label and a one-line rationale.","Choose the closest label from: job application, visa/immigration, university application, banking/finance, healthcare, government services, e-commerce checkout, file upload portal, AI chat, general form, other.",`Context: "${t.slice(0,1200)}"`].join(`
`)}]}],generationConfig:{maxOutputTokens:120,temperature:.2}})});if(!o.ok){const v=await o.text();throw new Error(`Gemini VLM error ${o.status}: ${v}`)}return((p=(l=(d=(m=(h=(await o.json()).candidates)==null?void 0:h[0])==null?void 0:m.content)==null?void 0:d.parts)==null?void 0:l[0])==null?void 0:p.text)||""}async function Z(e,t,a){var h,m,d,l;const o=await fetch(ve,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:"gpt-4o-mini",input:[{role:"user",content:[{type:"input_text",text:["You are classifying what type of website this is based on a screenshot and page context.","Return a short label and a one-line rationale.","Choose the closest label from: job application, visa/immigration, university application, banking/finance, healthcare, government services, e-commerce checkout, file upload portal, AI chat, general form, other.",`Context: "${t.slice(0,1200)}"`].join(`
`)},{type:"input_image",image_url:`data:image/png;base64,${e}`}]}],max_output_tokens:120,temperature:.2})});if(!o.ok){const p=await o.text();throw new Error(`ChatGPT VLM error ${o.status}: ${p}`)}return((l=(d=(m=(h=(await o.json()).output)==null?void 0:h[0])==null?void 0:m.content)==null?void 0:d[0])==null?void 0:l.text)||""}async function H(){if(M()>0)return;const e=await j();if(e){L(e),console.log("[xUpload] Vocab loaded from IndexedDB:",M(),"terms");return}return new Promise(t=>{chrome.storage.local.get("vocab",a=>{a.vocab?(L(a.vocab),console.log("[xUpload] Vocab loaded from chrome.storage:",M(),"terms"),Q(a.vocab).catch(()=>{})):console.warn("[xUpload] No vocab found."),t()})})}H();const $="xupload_debug_logs";(function(){chrome.storage.local.get($,t=>{const a=t[$];Array.isArray(a)&&a.length>0&&oe(a)}),ye(t=>{chrome.storage.local.set({[$]:t})})})();chrome.runtime.onMessage.addListener((e,t,a)=>{if(e.type==="MATCH_REQUEST")return B(e).then(a),!0;if(e.type==="GET_FILE")return Me(e.id).then(a),!0;if(e.type==="GET_INDEX_COUNT")return z().then(o=>a({count:o})),!0;if(e.type==="BUILD_INDEX")return ke(e.files,e.workflowId).then(a),!0;if(e.type==="VOCAB_UPDATED")return(async()=>{const o=await j();o?(L(o),console.log("[xUpload] Vocab reloaded from IndexedDB:",M(),"terms")):chrome.storage.local.get("vocab",c=>{c.vocab&&(L(c.vocab),console.log("[xUpload] Vocab reloaded from chrome.storage:",M(),"terms"))}),a({ok:!0})})(),!0;if(e.type==="TRACK_UPLOAD"){const o=e.entry;return ne(o).then(()=>{a({ok:!0})}).catch(c=>{console.error("[xUpload] Failed to track upload:",c),a({ok:!1})}),!0}if(e.type==="MATCH_REQUEST_ENHANCED")return Ce(e).then(a),!0;if(e.type==="CAPTURE_TAB")return chrome.tabs.captureVisibleTab({format:"png"},o=>{if(chrome.runtime.lastError){a({error:chrome.runtime.lastError.message});return}const c=(o==null?void 0:o.replace(/^data:image\/\w+;base64,/,""))||"";a({base64:c})}),!0;if(e.type==="SAVE_USED_PATH")return se(e.host,e.filePath).then(()=>a({ok:!0})).catch(()=>a({ok:!1})),!0;if(e.type==="RESCAN_CONFIG_UPDATED")return N().then(()=>a({ok:!0})),!0;if(e.type==="PAGE_CLASSIFY_REQUEST")return Te(e).then(a),!0;if(e.type==="GET_DEBUG_LOGS")return(async()=>{const o=await z();a({source:"background",logs:re(),meta:{indexedFiles:o,vocabSize:M(),timestamp:Date.now()}})})(),!0});function q(e,t){const a=new Set(V(e.replace(/[/\\._-]/g," "))),o=new Set(V(t));if(a.size===0||o.size===0)return 0;let c=0;for(const h of a)o.has(h)&&c++;const s=Math.min(a.size,o.size);return c/s}function ee(e,t){const a=new Set(V(e)),o=new Set(V(t));if(a.size===0||o.size===0)return 0;let c=0;for(const h of o)a.has(h)&&c++;const s=Math.min(a.size,o.size);return c/s}async function B(e){const t=e.workflowId||O("match-bg"),a=new Set;i(t,"match.start",{contextPreview:e.context.slice(0,140),accept:e.accept||"(none)",pageUrl:e.pageUrl||"(none)"});try{a.add("background.ensureVocab"),await H();const o=W(e.context),c=F(o);i(t,"service.tfidf.vectorize",{queryTokenCount:o.length,queryVectorSize:c.length}),a.add("vectordb.search");const s=c.length>0?await ce(c,15,e.accept):[],h=s.length>0?Math.max(...s.map(n=>n.score)):0,m=h>.05;i(t,"service.vectordb.search.done",{candidateCount:s.length,maxTfidf:b(h),tfidfUseful:m});let d=s;if(!m){a.add("vectordb.getAll");const n=await ie();let u=n;if(e.accept){const y=e.accept.split(",").map(w=>w.trim().toLowerCase()),E=n.filter(w=>{var f;const _="."+((f=w.name.split(".").pop())==null?void 0:f.toLowerCase()),S=w.type.toLowerCase();return y.some(x=>x===_||x===S||x.endsWith("/*")&&S.startsWith(x.replace("/*","/")))});E.length>0&&(u=E)}d=u.map(y=>({record:y,score:0})),i(t,"ranking.fallback.path_content",{reason:"tfidf_low_signal",maxTfidf:b(h),fullCandidateCount:d.length})}let l="";if(e.pageUrl)try{l=new URL(e.pageUrl).hostname}catch{l=""}let p=[],v=[];l&&(a.add("vectordb.getHistoryByHost"),a.add("vectordb.getUsedPaths"),p=await K(l),v=await Y(l),i(t,"service.history.lookup.done",{host:l,historyRows:p.length,memorizedPaths:v.length}));const D=new Set(v),A=new Map;for(const n of p){const u=A.get(n.fileId);u?(u.count++,u.lastTs=Math.max(u.lastTs,n.timestamp)):A.set(n.fileId,{count:1,lastTs:n.timestamp})}const I=24*60*60*1e3,U=Date.now(),k=/resume|cv|简历|job application/i.test(e.context)||/resume|cv|简历|job application/i.test(e.pageUrl||""),r=d.map(n=>{const u=n.score;let y=0,E=0;const w=A.get(n.record.id);if(w){E=w.count;const ae=(U-w.lastTs)/I;y=Math.max(.1,1-ae/90)}const _=q(n.record.path,e.context),S=ee(n.record.textPreview,e.context),f=D.has(n.record.path)?1:0,x=k&&/resume|cv|简历/i.test(n.record.path)?1:0,P=y>0,C=m?P?{tfidf:.36,history:.24,path:.12,content:.07,pathMemory:.07,resume:.14}:{tfidf:.48,history:0,path:.18,content:.12,pathMemory:.06,resume:.16}:P?{tfidf:0,history:.3,path:.25,content:.18,pathMemory:.1,resume:.17}:{tfidf:0,history:0,path:.34,content:.3,pathMemory:.12,resume:.24},te=u*C.tfidf+y*C.history+_*C.path+S*C.content+f*C.pathMemory+x*C.resume;return{...n,score:te,historyCount:E,debug:{tfidfScore:u,historyBoost:y,pathNameScore:_,contentOverlap:S,pathMemoryBoost:f,resumeBoost:x,weights:C}}});r.sort((n,u)=>u.score-n.score);const g=r.slice(0,5).filter(n=>n.score>0);return i(t,"ranking.breakdown.top_candidates",r.slice(0,10).map((n,u)=>({rank:u+1,file:n.record.name,path:n.record.path,finalScore:b(n.score),tfidfScore:b(n.debug.tfidfScore),historyBoost:b(n.debug.historyBoost),pathNameScore:b(n.debug.pathNameScore),contentOverlap:b(n.debug.contentOverlap),pathMemoryBoost:n.debug.pathMemoryBoost,resumeBoost:n.debug.resumeBoost,historyCount:n.historyCount,weights:n.debug.weights}))),i(t,"match.services_called",Array.from(a)),i(t,"match.done",{candidateCount:r.length,returnedCount:g.length,results:g.map(n=>`${n.record.name} (${Math.round(n.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:g.map(n=>({id:n.record.id,name:n.record.name,path:n.record.path,type:n.record.type,score:n.score,historyCount:n.historyCount}))}}catch(o){throw T(t,"match.failed",o),o}}async function R(){return new Promise(e=>{chrome.storage.local.get("xupload_config",t=>{e(t.xupload_config||{apiKey:"",mode:"tfidf"})})})}async function Ce(e){const t=e.workflowId||O("match-enhanced-bg"),a=new Set(["chrome.storage.local.get:xupload_config"]);i(t,"match.enhanced.start",{mode:e.mode,hasScreenshot:!!e.screenshotBase64,contextPreview:e.context.slice(0,140),accept:e.accept||"(none)"});const o=await R();if(!o.apiKey)return i(t,"match.enhanced.fallback",{reason:"missing_api_key"}),B({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let c=e.context;if((e.mode==="vlm"||e.mode==="vlm_gpt")&&e.screenshotBase64)try{if(e.mode==="vlm_gpt"){a.add("chatgpt.describeWithVLM"),i(t,"service.chatgpt.describeWithVLM.start");const s=await Z(e.screenshotBase64,e.context,o.apiKey);i(t,"service.chatgpt.describeWithVLM.done",{descriptionPreview:s.slice(0,160)}),c=`${s} ${e.context}`}else{a.add("gemini.describeWithVLM"),i(t,"service.gemini.describeWithVLM.start");const s=await Se(e.screenshotBase64,e.context,o.apiKey);i(t,"service.gemini.describeWithVLM.done",{descriptionPreview:s.slice(0,160)}),c=`${s} ${e.context}`}}catch(s){T(t,e.mode==="vlm_gpt"?"service.chatgpt.describeWithVLM.failed":"service.gemini.describeWithVLM.failed",s)}try{let s=[];e.mode==="vlm_gpt"?(a.add("chatgpt.getEmbedding"),i(t,"service.chatgpt.getEmbedding.start"),s=await xe(c,o.apiKey)):(a.add("gemini.getEmbedding"),i(t,"service.gemini.getEmbedding.start"),s=await X(c,o.apiKey)),a.add("vectordb.denseSearch");const h=await de(s,5,e.accept);if(i(t,"service.vectordb.denseSearch.done",{queryVectorSize:s.length,candidateCount:h.length}),h.length===0)return i(t,"match.enhanced.fallback",{reason:"dense_no_results"}),B({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t});let m=[],d=[],l="";if(e.pageUrl)try{l=new URL(e.pageUrl).hostname}catch{}if(l){try{a.add("vectordb.getHistoryByHost"),m=await K(l)}catch{}try{a.add("vectordb.getUsedPaths"),d=await Y(l)}catch{}}const p=new Map;for(const r of m){const g=p.get(r.fileId);g?p.set(r.fileId,{count:g.count+1,lastTs:Math.max(g.lastTs,r.timestamp)}):p.set(r.fileId,{count:1,lastTs:r.timestamp})}const v=new Set(d),D=24*60*60*1e3,A=Date.now(),I=/resume|cv|简历|job application/i.test(e.context)||/resume|cv|简历|job application/i.test(e.pageUrl||""),U=h.map(r=>{const g=r.score;let n=0,u=0;const y=p.get(r.record.id);if(y){u=y.count;const P=(A-y.lastTs)/D;n=Math.max(.1,1-P/90)}const E=q(r.record.path,e.context),w=ee(r.record.textPreview,e.context),_=v.has(r.record.path)?1:0,S=I&&/resume|cv|简历/i.test(r.record.path)?1:0,f={dense:.35,history:.1,path:.16,content:.06,pathMemory:.02,resume:.31},x=g*f.dense+n*f.history+E*f.path+w*f.content+_*f.pathMemory+S*f.resume;return{...r,score:x,historyCount:u,debug:{denseScore:g,historyBoost:n,pathNameScore:E,contentOverlap:w,pathMemoryBoost:_,resumeBoost:S,weights:f}}});U.sort((r,g)=>g.score-r.score);const k=U.slice(0,5);return i(t,"match.enhanced.ranking.top_candidates",k.map((r,g)=>({rank:g+1,file:r.record.name,path:r.record.path,finalScore:b(r.score),denseScore:b(r.debug.denseScore),historyBoost:b(r.debug.historyBoost),pathNameScore:b(r.debug.pathNameScore),contentOverlap:b(r.debug.contentOverlap),pathMemoryBoost:r.debug.pathMemoryBoost,resumeBoost:r.debug.resumeBoost,historyCount:r.historyCount,weights:r.debug.weights}))),i(t,"match.enhanced.services_called",Array.from(a)),i(t,"match.enhanced.done",{returnedCount:k.length,top:k.map(r=>`${r.record.name} (${Math.round(r.score*100)}%)`)}),{type:"MATCH_RESPONSE",workflowId:t,results:k.map(r=>({id:r.record.id,name:r.record.name,path:r.record.path,type:r.record.type,score:r.score,historyCount:r.historyCount}))}}catch(s){return T(t,"match.enhanced.failed",s),B({type:"MATCH_REQUEST",context:e.context,accept:e.accept,pageUrl:e.pageUrl,workflowId:t})}}async function Te(e){const t=e.workflowId||O("classify-page-bg");i(t,"classify.page.start",{hasScreenshot:!!e.screenshotBase64,contextPreview:e.context.slice(0,140),pageUrl:e.pageUrl});try{const a=await R();if(!a.apiKey)return T(t,"classify.page.missing_api_key",null),{type:"PAGE_CLASSIFY_RESPONSE",ok:!1,workflowId:t,error:"missing_api_key"};let o=e.screenshotBase64;if(o||(i(t,"service.chrome.captureVisibleTab.start"),o=(await new Promise((h,m)=>{const d=e.windowId??chrome.windows.WINDOW_ID_CURRENT;chrome.tabs.captureVisibleTab(d,{format:"png"},l=>{var p;if(chrome.runtime.lastError||!l){m(new Error(((p=chrome.runtime.lastError)==null?void 0:p.message)||"capture_failed"));return}h(l)})})).replace(/^data:image\/\w+;base64,/,""),i(t,"service.chrome.captureVisibleTab.done")),e.mode==="vlm_gpt"){i(t,"service.chatgpt.page_classify.start");const s=await Z(o,e.context,a.apiKey);return i(t,"service.chatgpt.page_classify.done",{labelPreview:s.slice(0,160)}),{type:"PAGE_CLASSIFY_RESPONSE",ok:!0,workflowId:t,label:s}}i(t,"service.gemini.page_classify.start");const c=await _e(o,e.context,a.apiKey);return i(t,"service.gemini.page_classify.done",{labelPreview:c.slice(0,160)}),{type:"PAGE_CLASSIFY_RESPONSE",ok:!0,workflowId:t,label:c}}catch(a){return T(t,"classify.page.failed",a),{type:"PAGE_CLASSIFY_RESPONSE",ok:!1,workflowId:t,error:"classify_failed"}}}async function ke(e,t=O("scan-bg")){const a=new Set(["embeddings.tokenize","embeddings.buildVocabulary","vectordb.clearAll","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","vectordb.getCount"]);i(t,"scan.background.start",{fileCount:e.length,mode:"full"});try{const o=e.map(d=>W(d.text));le(o),i(t,"scan.phase.tfidf.done",{tokenizedFiles:o.length}),await he(),i(t,"service.vectordb.clearAll.done");const c=await R();a.add("chrome.storage.local.get:xupload_config");let s=new Array(e.length).fill(void 0);if(c.apiKey&&c.mode!=="tfidf"){a.add("gemini.batchEmbed"),i(t,"service.gemini.batchEmbed.start",{fileCount:e.length,mode:c.mode});try{const d=e.map(p=>p.text.slice(0,2e3)),l=await Ee(d,c.apiKey,10,(p,v)=>{i(t,"service.gemini.batchEmbed.progress",{done:p,total:v})});s=l,i(t,"service.gemini.batchEmbed.done",{vectorCount:l.length})}catch(d){T(t,"service.gemini.batchEmbed.failed",d)}}for(let d=0;d<e.length;d++){const l=e[d],p=F(o[d]);await pe({id:l.path,name:l.name,path:l.path,type:l.type,size:l.size,lastModified:l.lastModified,vector:p,denseVector:s[d],textPreview:l.text.slice(0,500)})}i(t,"service.vectordb.upsert.done",{upserted:e.length});const h=me();await Q(h),await new Promise(d=>{chrome.storage.local.set({vocab:h},d)}),i(t,"service.vocab.persist.done",{termCount:h.terms.length});const m=await z();return i(t,"scan.background.services_called",Array.from(a)),i(t,"scan.background.done",{indexedCount:m}),{ok:!0,count:m,workflowId:t}}catch(o){return T(t,"scan.background.failed",o),{ok:!1,error:(o==null?void 0:o.message)||String(o),workflowId:t}}}async function Me(e){console.log("[xUpload] GET_FILE:",e);const t=await ue(e);return t?(console.log("[xUpload] Sending:",t.name),t):{error:"Cannot read file. Please re-scan the folder from the xUpload popup."}}const G="xupload-rescan";async function N(){await chrome.alarms.clear(G);const e=await ge();e.autoRescanEnabled&&e.rescanIntervalMin>0?(chrome.alarms.create(G,{periodInMinutes:e.rescanIntervalMin}),console.log(`[xUpload] Rescan alarm set: every ${e.rescanIntervalMin} min`)):console.log("[xUpload] Auto-rescan disabled")}chrome.alarms.onAlarm.addListener(async e=>{if(e.name!==G)return;console.log("[xUpload] Auto-rescan alarm fired");const t=await fe();if(!t){console.log("[xUpload] No directory handle, skipping auto-rescan");return}try{if(await t.queryPermission({mode:"read"})!=="granted"){console.log("[xUpload] Directory permission not granted, skipping auto-rescan"),chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#ea4335"});return}chrome.action.setBadgeText({text:""}),console.log("[xUpload] Auto-rescan: directory handle valid, notifying tabs")}catch(a){console.error("[xUpload] Auto-rescan error:",a)}});chrome.runtime.onStartup.addListener(()=>{console.log("[xUpload] Extension started"),H(),N()});chrome.runtime.onInstalled.addListener(()=>{console.log("[xUpload] Extension installed/updated"),N()});N();
