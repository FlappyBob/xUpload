const O=new Set(["a","an","the","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","shall","should","may","might","must","can","could","i","me","my","we","our","you","your","he","him","his","she","her","it","its","they","them","their","this","that","these","those","am","if","or","and","but","not","no","nor","so","as","at","by","for","in","of","on","to","up","from","with","into","out","about","all","any","each","some","such","than","too","very","just","also","how","what","when","where","which","who","here","there","then","only","after","before"]);function $(t){const o=t.toLowerCase().trim(),n=[],r=o.match(/[a-z0-9]+/g)||[];n.push(...r);const e=o.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g)||[];n.push(...e);for(let s=0;s<e.length-1;s++)n.push(e[s]+e[s+1]);return n}function U(t){return $(t).filter(o=>!O.has(o)&&o.length>1)}let p=new Map,g=new Map;function _(t){const o=new Map,n=t.length;for(const e of t){const s=new Set(e);for(const a of s)o.set(a,(o.get(a)||0)+1)}p=new Map,g=new Map;let r=0;for(const[e,s]of o)p.set(e,r++),g.set(e,Math.log((n+1)/(s+1))+1)}function L(){return p.size}function N(t){const o=p.size;if(o===0)return[];const n=new Array(o).fill(0),r=new Map;for(const a of t)r.set(a,(r.get(a)||0)+1);const e=Math.max(...r.values(),1);for(const[a,c]of r){const i=p.get(a);i!==void 0&&(n[i]=c/e*(g.get(a)||1))}let s=0;for(const a of n)s+=a*a;if(s=Math.sqrt(s),s>0)for(let a=0;a<n.length;a++)n[a]/=s;return n}async function z(t,o){var s;const n=t.name.replace(/[._-]/g," "),r=((s=t.name.split(".").pop())==null?void 0:s.toLowerCase())||"",e=o?o.replace(/[/\\._-]/g," "):n;if(C(r))try{const a=await t.text();return`${e} ${a.slice(0,2e3)}`}catch{return e}if(r==="pdf")try{const a=await D(t);return a.length>10?`${e} ${a.slice(0,2e3)}`:`${e} pdf document`}catch{return`${e} pdf document`}return["jpg","jpeg","png","gif","webp","bmp","svg","tiff","heic"].includes(r)?`${e} image photo picture`:["doc","docx"].includes(r)?`${e} document word`:["xls","xlsx"].includes(r)?`${e} spreadsheet excel`:["ppt","pptx"].includes(r)?`${e} presentation slides`:e}function C(t){return["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"].includes(t)}async function D(t){const o=await t.arrayBuffer(),n=new Uint8Array(o);let r="";const e=Math.min(n.length,5e5);for(let i=0;i<e;i++)r+=String.fromCharCode(n[i]);const s=[],a=/BT\s([\s\S]*?)ET/g;let c;for(;(c=a.exec(r))!==null;){const i=/\(([^)]*)\)/g;let u;for(;(u=i.exec(c[1]))!==null;)s.push(u[1])}return s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim()}function R(){const t=new Array(p.size),o=new Array(p.size);for(const[n,r]of p)t[r]=n,o[r]=g.get(n)||1;return{terms:t,idf:o}}function V(t){p=new Map,g=new Map;for(let o=0;o<t.terms.length;o++)p.set(t.terms[o],o),g.set(t.terms[o],t.idf[o])}const E="xupload_vectors",T=5,f="files",y="dir_handles",b="vocabulary",x="upload_history",m="config";function d(){return new Promise((t,o)=>{const n=indexedDB.open(E,T);n.onupgradeneeded=()=>{const r=n.result;if(r.objectStoreNames.contains(f)&&r.deleteObjectStore(f),r.createObjectStore(f,{keyPath:"id"}),r.objectStoreNames.contains(y)||r.createObjectStore(y),r.objectStoreNames.contains(b)||r.createObjectStore(b),!r.objectStoreNames.contains(x)){const e=r.createObjectStore(x,{keyPath:"id",autoIncrement:!0});e.createIndex("websiteHost","websiteHost",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}r.objectStoreNames.contains(m)||r.createObjectStore(m)},n.onsuccess=()=>t(n.result),n.onerror=()=>o(n.error)})}async function F(t){const o=await d();return new Promise((n,r)=>{const e=o.transaction(f,"readwrite");e.objectStore(f).put(t),e.oncomplete=()=>n(),e.onerror=()=>r(e.error)})}async function P(){const t=await d();return new Promise((o,n)=>{const e=t.transaction(f,"readonly").objectStore(f).getAll();e.onsuccess=()=>o(e.result),e.onerror=()=>n(e.error)})}async function A(t){const o=await d();return new Promise((n,r)=>{const s=o.transaction(f,"readonly").objectStore(f).get(t);s.onsuccess=()=>n(s.result??void 0),s.onerror=()=>r(s.error)})}async function W(){const t=await d();return new Promise((o,n)=>{const e=t.transaction(f,"readonly").objectStore(f).count();e.onsuccess=()=>o(e.result),e.onerror=()=>n(e.error)})}async function k(){const t=await d();return new Promise((o,n)=>{const r=t.transaction(f,"readwrite");r.objectStore(f).clear(),r.oncomplete=()=>o(),r.onerror=()=>n(r.error)})}function M(t,o){let n=0,r=0,e=0;for(let s=0;s<t.length;s++)n+=t[s]*o[s],r+=t[s]*t[s],e+=o[s]*o[s];return r===0||e===0?0:n/(Math.sqrt(r)*Math.sqrt(e))}async function I(t,o=5,n){const r=await P();let e=r;if(n){const s=n.split(",").map(c=>c.trim().toLowerCase()),a=r.filter(c=>{var h;const i="."+((h=c.name.split(".").pop())==null?void 0:h.toLowerCase()),u=c.type.toLowerCase();return s.some(l=>l===i||l===u||l.endsWith("/*")&&u.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:M(t,s.vector)})).sort((s,a)=>a.score-s.score).slice(0,o).filter(s=>s.score>0)}async function G(t){const o=await d();return new Promise((n,r)=>{const e=o.transaction(y,"readwrite");e.objectStore(y).put(t,"main"),e.oncomplete=()=>n(),e.onerror=()=>r(e.error)})}async function B(){const t=await d();return new Promise((o,n)=>{const e=t.transaction(y,"readonly").objectStore(y).get("main");e.onsuccess=()=>o(e.result??null),e.onerror=()=>n(e.error)})}async function K(t){const o=await A(t);if(!o)return console.error("[xUpload] getFileData: record not found for id:",t),null;const n=await B();if(!n)return console.error("[xUpload] getFileData: no directory handle stored"),null;try{const r=await n.queryPermission({mode:"read"});if(console.log("[xUpload] Directory handle permission:",r),r!=="granted"){const l=await n.requestPermission({mode:"read"});if(console.log("[xUpload] Permission after request:",l),l!=="granted")return console.error("[xUpload] Permission denied for directory handle"),null}const e=o.path.split("/");console.log("[xUpload] Navigating path parts:",e);let s=n;for(let l=0;l<e.length-1;l++)s=await s.getDirectoryHandle(e[l]);const i=await(await(await s.getFileHandle(e[e.length-1])).getFile()).arrayBuffer(),u=new Uint8Array(i);let h="";for(let l=0;l<u.length;l++)h+=String.fromCharCode(u[l]);return{name:o.name,type:o.type,lastModified:o.lastModified,base64:btoa(h)}}catch(r){return console.error("[xUpload] Failed to read file on-demand:",r),null}}async function X(t){const o=await d();return new Promise((n,r)=>{const e=o.transaction(b,"readwrite");e.objectStore(b).put(t,"main"),e.oncomplete=()=>n(),e.onerror=()=>r(e.error)})}async function Y(){const t=await d();return new Promise((o,n)=>{const e=t.transaction(b,"readonly").objectStore(b).get("main");e.onsuccess=()=>o(e.result??null),e.onerror=()=>n(e.error)})}async function J(t){const o=await d();return new Promise((n,r)=>{const e=o.transaction(x,"readwrite");e.objectStore(x).add(t),e.oncomplete=()=>n(),e.onerror=()=>r(e.error)})}async function Q(t,o=50){const n=await d();return new Promise((r,e)=>{const c=n.transaction(x,"readonly").objectStore(x).index("websiteHost").getAll(t,o);c.onsuccess=()=>r(c.result),c.onerror=()=>e(c.error)})}async function Z(t){const o=await d();return new Promise((n,r)=>{const e=o.transaction(f,"readwrite");e.objectStore(f).delete(t),e.oncomplete=()=>n(),e.onerror=()=>r(e.error)})}async function ee(){const t=await d();return new Promise((o,n)=>{const e=t.transaction(m,"readonly").objectStore(m).get("rescan");e.onsuccess=()=>o(e.result??{autoRescanEnabled:!0,rescanIntervalMin:30,lastScanTimestamp:0}),e.onerror=()=>n(e.error)})}async function te(t){const o=await d();return new Promise((n,r)=>{const e=o.transaction(m,"readwrite");e.objectStore(m).put(t,"rescan"),e.oncomplete=()=>n(),e.onerror=()=>r(e.error)})}async function oe(t,o=5,n){let e=(await P()).filter(s=>s.denseVector&&s.denseVector.length>0);if(e.length===0)return[];if(n){const s=n.split(",").map(c=>c.trim().toLowerCase()),a=e.filter(c=>{var h;const i="."+((h=c.name.split(".").pop())==null?void 0:h.toLowerCase()),u=c.type.toLowerCase();return s.some(l=>l===i||l===u||l.endsWith("/*")&&u.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:M(t,s.denseVector)})).sort((s,a)=>a.score-s.score).slice(0,o).filter(s=>s.score>0)}async function ne(t,o){const n=await d(),r=await new Promise((a,c)=>{const u=n.transaction(m,"readonly").objectStore(m).get("pathMemory");u.onsuccess=()=>a(u.result??{}),u.onerror=()=>c(u.error)}),e=r[t]||[],s=e.indexOf(o);return s!==-1&&e.splice(s,1),e.unshift(o),e.length>20&&(e.length=20),r[t]=e,new Promise((a,c)=>{const i=n.transaction(m,"readwrite");i.objectStore(m).put(r,"pathMemory"),i.oncomplete=()=>a(),i.onerror=()=>c(i.error)})}async function re(t){const o=await d();return new Promise((n,r)=>{const s=o.transaction(m,"readonly").objectStore(m).get("pathMemory");s.onsuccess=()=>{const a=s.result??{};n(a[t]||[])},s.onerror=()=>r(s.error)})}const v=500,w=[];let S=null,j=null;function q(t){w.length>=v&&w.shift(),w.push(t),H()}function H(){S&&(j||(j=setTimeout(()=>{j=null,S==null||S(w.slice())},1e3)))}function se(t){S=t}function ae(t){w.length=0;for(const o of t.slice(-v))w.push(o)}function ce(){return w.slice()}function ie(t){const o=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${t}-${o}-${n}`}function le(t,o=4){const n=Math.pow(10,o);return Math.round(t*n)/n}function ue(t,o,n){if(q({ts:Date.now(),level:"info",workflowId:t,step:o,data:n}),n===void 0){console.log(`[xUpload][WF:${t}] ${o}`);return}console.log(`[xUpload][WF:${t}] ${o}`,n)}function de(t,o,n){const r=n instanceof Error?{message:n.message,stack:n.stack}:n;q({ts:Date.now(),level:"error",workflowId:t,step:o,data:r}),console.error(`[xUpload][WF:${t}] ${o}`,n)}export{B as A,U as B,se as C,G as D,z as E,Z as F,te as G,Y as a,L as b,J as c,ce as d,ie as e,ue as f,W as g,I as h,V as i,P as j,Q as k,ae as l,re as m,de as n,oe as o,_ as p,k as q,le as r,ne as s,$ as t,F as u,N as v,R as w,X as x,K as y,ee as z};
