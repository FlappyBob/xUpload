import{g as T,m as j,n as q,o as F,p as H,q as U,t as V,e as _,f as G,v as B,u as S,h as K,j as W,l as C,r as z}from"./vectordb.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const r of c.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(a){if(a.ep)return;a.ep=!0;const c=t(a);fetch(a.href,c)}})();const R=document.getElementById("count"),v=document.getElementById("scanBtn"),u=document.getElementById("rescanBtn"),d=document.getElementById("progress"),b=document.getElementById("fileList"),y=document.getElementById("lastScan"),g=document.getElementById("autoRescan"),p=document.getElementById("rescanInterval");T().then(e=>R.textContent=String(e));Q();k();v.addEventListener("click",async()=>{try{const e=await window.showDirectoryPicker({mode:"read"});await A(e,!1)}catch(e){e.name!=="AbortError"&&(console.error("[xUpload] Scan error:",e),d.textContent="Error scanning folder")}});u&&u.addEventListener("click",async()=>{try{const e=await j();if(!e){d.textContent="No folder selected yet. Use 'Select folder' first.";return}if(await e.queryPermission({mode:"read"})!=="granted"&&await e.requestPermission({mode:"read"})!=="granted"){d.textContent="Permission denied. Please select folder again.";return}await A(e,!0)}catch(e){console.error("[xUpload] Rescan error:",e),d.textContent="Error during rescan. Try selecting folder again."}});g&&g.addEventListener("change",O);p&&p.addEventListener("change",O);async function A(e,o){v.disabled=!0,u&&(u.disabled=!0),d.textContent="Scanning files...";const t=await N(e,"");d.textContent=`Found ${t.length} files. Checking for changes...`,await q(e);const s=o?await F():[],a=new Map(s.map(n=>[n.id,n])),c=new Set,r=[],m=[];let h=0;for(let n=0;n<t.length;n++){const{fileHandle:l,path:f}=t[n];c.add(f);try{const i=await l.getFile();if(o){const w=a.get(f);if(w&&w.size===i.size&&w.lastModified===i.lastModified){m.push({path:f,name:i.name,type:i.type||P(i.name),size:i.size,lastModified:i.lastModified,text:w.textPreview}),h++;continue}}const M=await H(i);r.push({path:f,name:i.name,type:i.type||P(i.name),size:i.size,lastModified:i.lastModified,text:M})}catch{}n%10===0&&(d.textContent=`Reading files... ${n+1}/${t.length}${h>0?` (${h} unchanged)`:""}`)}let x=0;if(o)for(const n of a.keys())c.has(n)||(await U(n),x++);if(o&&r.length===0&&x===0){d.textContent=`No changes detected. ${h} files up to date.`,v.disabled=!1,u&&(u.disabled=!1),await D();return}d.textContent=`Building vectors... (${r.length} new/modified, ${h} unchanged, ${x} deleted)`;const L=[...r,...m],E=L.map(n=>V(n.text));_(E),o||await G();for(let n=0;n<r.length;n++){const l=r[n],f=B(E[n]),i={id:l.path,name:l.name,path:l.path,type:l.type,size:l.size,lastModified:l.lastModified,vector:f,textPreview:l.text.slice(0,100)};await S(i),n%10===0&&(d.textContent=`Indexing... ${n+1}/${r.length}`)}if(o&&m.length>0){d.textContent="Updating vectors for unchanged files...";for(let n=0;n<m.length;n++){const l=m[n],f=r.length+n,i=B(E[f]),M=a.get(l.path);await S({...M,vector:i})}}const I=K();await W(I),chrome.storage.local.set({vocab:I},()=>{chrome.runtime.sendMessage({type:"VOCAB_UPDATED"})}),await D();const $=await T();R.textContent=String($),d.textContent=o?`Done! ${r.length} updated, ${x} removed, ${$} total.`:`Done! ${$} files indexed.`,v.disabled=!1,u&&(u.disabled=!1),J(L)}async function N(e,o){const t=[];for await(const s of e.values()){const a=o?`${o}/${s.name}`:s.name;if(s.kind==="file")t.push({fileHandle:s,path:a});else if(s.kind==="directory"&&!s.name.startsWith(".")){const c=await N(s,a);t.push(...c)}}return t}function P(e){var s;const o=((s=e.split(".").pop())==null?void 0:s.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[o]||"application/octet-stream"}function J(e){b.innerHTML="";const o=[...e].sort((t,s)=>s.lastModified-t.lastModified);for(const t of o.slice(0,50)){const s=document.createElement("div");s.textContent=t.path,b.appendChild(s)}if(e.length>50){const t=document.createElement("div");t.textContent=`... and ${e.length-50} more`,b.appendChild(t)}}async function Q(){const e=await C();g&&(g.checked=e.autoRescanEnabled),p&&(p.value=String(e.rescanIntervalMin))}async function O(){const e=await C();e.autoRescanEnabled=(g==null?void 0:g.checked)??!0,e.rescanIntervalMin=parseInt((p==null?void 0:p.value)??"30",10),await z(e),chrome.runtime.sendMessage({type:"RESCAN_CONFIG_UPDATED"})}async function D(){const e=await C();e.lastScanTimestamp=Date.now(),await z(e),k()}async function k(){if(!y)return;const e=await C();if(e.lastScanTimestamp===0){y.textContent="Never scanned";return}const o=Date.now()-e.lastScanTimestamp,t=Math.floor(o/6e4);t<1?y.textContent="Last scan: just now":t<60?y.textContent=`Last scan: ${t}m ago`:y.textContent=`Last scan: ${Math.floor(t/60)}h ${t%60}m ago`}
