import{g as k,d as z,l as i,k as I,y as J,A as Q,f as X,B as Y,C as Z,t as ee,n as te,o as ne,v as H,u as O,p as ae,q as se,x as M,D as q}from"./workflow.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const m of r.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const V=document.getElementById("count"),D=document.getElementById("scanBtn"),f=document.getElementById("rescanBtn"),d=document.getElementById("progress"),_=document.getElementById("fileList"),C=document.getElementById("lastScan"),h=document.getElementById("autoRescan"),v=document.getElementById("rescanInterval"),y=document.getElementById("apiKey"),x=document.getElementById("matchMode"),w=document.getElementById("enableToggle");k().then(e=>V.textContent=String(e));ie();ce();W();re();D.addEventListener("click",async()=>{const e=z("scan-popup");i(e,"scan.popup.click");try{i(e,"service.filesystem.showDirectoryPicker.start");const t=await window.showDirectoryPicker({mode:"read"});i(e,"service.filesystem.showDirectoryPicker.done"),await j(t,!1,e)}catch(t){t.name!=="AbortError"?(I(e,"scan.popup.failed",t),d.textContent="Error scanning folder",D.disabled=!1,f&&(f.disabled=!1)):i(e,"scan.popup.cancelled")}});f&&f.addEventListener("click",async()=>{const e=z("rescan-popup");i(e,"rescan.popup.click");try{i(e,"service.vectordb.getDirectoryHandle.start");const t=await J();if(!t){i(e,"rescan.popup.no_directory_handle"),d.textContent="No folder selected yet. Use 'Select folder' first.";return}const n=await t.queryPermission({mode:"read"});if(i(e,"service.filesystem.queryPermission.done",{permission:n}),n!=="granted"){const a=await t.requestPermission({mode:"read"});if(i(e,"service.filesystem.requestPermission.done",{permission:a}),a!=="granted"){d.textContent="Permission denied. Please select folder again.";return}}await j(t,!0,e)}catch(t){I(e,"rescan.popup.failed",t),d.textContent="Error during rescan. Try selecting folder again.",D.disabled=!1,f&&(f.disabled=!1)}});h&&h.addEventListener("change",K);v&&v.addEventListener("change",K);async function j(e,t,n=z(t?"rescan-popup":"scan-popup")){const a=new Set(["filesystem.collectFiles","vectordb.saveDirectoryHandle","embeddings.extractText","embeddings.tokenize","embeddings.buildVocabulary","embeddings.vectorize","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","chrome.runtime.sendMessage:VOCAB_UPDATED","vectordb.getCount"]);i(n,"scan.popup.start",{incremental:t}),D.disabled=!0,f&&(f.disabled=!0),d.textContent="Scanning files...";try{const s=await U(e,"");d.textContent=`Found ${s.length} files. Checking for changes...`,i(n,"service.filesystem.collectFiles.done",{discoveredFiles:s.length}),await Q(e),i(n,"service.vectordb.saveDirectoryHandle.done");const r=t?await X():[],m=new Map(r.map(o=>[o.id,o])),F=new Set;t&&(a.add("vectordb.getAll"),a.add("vectordb.deleteById"));const l=[],b=[];let u=0,$=0;for(let o=0;o<s.length;o++){const{fileHandle:p,path:g}=s[o];F.add(g);try{const c=await p.getFile();if(t){const L=m.get(g);if(L&&L.size===c.size&&L.lastModified===c.lastModified){b.push({path:g,name:c.name,type:c.type||R(c.name),size:c.size,lastModified:c.lastModified,text:L.textPreview}),u++;continue}}const S=await Y(c,g);l.push({path:g,name:c.name,type:c.type||R(c.name),size:c.size,lastModified:c.lastModified,text:S})}catch{$++}o%10===0&&(d.textContent=`Reading files... ${o+1}/${s.length}${u>0?` (${u} unchanged)`:""}`)}i(n,"scan.phase.read.done",{discovered:s.length,toProcess:l.length,unchanged:u,unreadable:$});let E=0;if(t){for(const o of m.keys())F.has(o)||(await Z(o),E++);i(n,"scan.phase.deleted.done",{deleted:E})}if(t&&l.length===0&&E===0){d.textContent=`No changes detected. ${u} files up to date.`,await N(),i(n,"scan.popup.no_changes",{unchanged:u}),i(n,"scan.popup.services_called",Array.from(a));return}d.textContent=`Building vectors... (${l.length} new/modified, ${u} unchanged, ${E} deleted)`;const P=[...l,...b],A=P.map(o=>ee(o.text));te(A),i(n,"scan.phase.vocab.done",{vocabDocs:P.length}),t||(await ne(),a.add("vectordb.clearAll"),i(n,"service.vectordb.clearAll.done"));for(let o=0;o<l.length;o++){const p=l[o],g=H(A[o]),c={id:p.path,name:p.name,path:p.path,type:p.type,size:p.size,lastModified:p.lastModified,vector:g,textPreview:p.text.slice(0,500)};await O(c),o%10===0&&(d.textContent=`Indexing... ${o+1}/${l.length}`)}if(t&&b.length>0){d.textContent="Updating vectors for unchanged files...";for(let o=0;o<b.length;o++){const p=b[o],g=l.length+o,c=H(A[g]),S=m.get(p.path);await O({...S,vector:c})}}i(n,"scan.phase.index.done",{updated:l.length,revectorized:b.length});const T=ae();await se(T),chrome.storage.local.set({vocab:T},()=>{chrome.runtime.sendMessage({type:"VOCAB_UPDATED"},()=>{chrome.runtime.lastError})}),i(n,"scan.phase.persist.done",{vocabTerms:T.terms.length}),await N();const B=await k();V.textContent=String(B),d.textContent=t?`Done! ${l.length} updated, ${E} removed, ${B} total.`:`Done! ${B} files indexed.`,oe(P),i(n,"scan.popup.services_called",Array.from(a)),i(n,"scan.popup.done",{totalIndexed:B,updated:l.length,unchanged:u,deleted:E,unreadable:$})}catch(s){I(n,"scan.popup.failed",s),d.textContent=t?"Error during rescan. Try selecting folder again.":"Error scanning folder"}finally{D.disabled=!1,f&&(f.disabled=!1)}}async function U(e,t){const n=[];for await(const a of e.values()){const s=t?`${t}/${a.name}`:a.name;if(a.kind==="file")n.push({fileHandle:a,path:s});else if(a.kind==="directory"&&!a.name.startsWith(".")){const r=await U(a,s);n.push(...r)}}return n}function R(e){var a;const t=((a=e.split(".").pop())==null?void 0:a.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[t]||"application/octet-stream"}function oe(e){_.innerHTML="";const t=[...e].sort((n,a)=>a.lastModified-n.lastModified);for(const n of t.slice(0,50)){const a=document.createElement("div");a.textContent=n.path,_.appendChild(a)}if(e.length>50){const n=document.createElement("div");n.textContent=`... and ${e.length-50} more`,_.appendChild(n)}}async function ie(){const e=await M();h&&(h.checked=e.autoRescanEnabled),v&&(v.value=String(e.rescanIntervalMin))}async function K(){const e=await M();e.autoRescanEnabled=(h==null?void 0:h.checked)??!0,e.rescanIntervalMin=parseInt((v==null?void 0:v.value)??"30",10),await q(e),chrome.runtime.sendMessage({type:"RESCAN_CONFIG_UPDATED"},()=>{chrome.runtime.lastError})}async function N(){const e=await M();e.lastScanTimestamp=Date.now(),await q(e),W()}async function W(){if(!C)return;const e=await M();if(e.lastScanTimestamp===0){C.textContent="Never scanned";return}const t=Date.now()-e.lastScanTimestamp,n=Math.floor(t/6e4);n<1?C.textContent="Last scan: just now":n<60?C.textContent=`Last scan: ${n}m ago`:C.textContent=`Last scan: ${Math.floor(n/60)}h ${n%60}m ago`}function ce(){chrome.storage.local.get("xupload_config",e=>{const t=e.xupload_config||{apiKey:"",mode:"tfidf"};y&&(y.value=t.apiKey||""),x&&(x.value=t.mode||"tfidf")})}function G(){const e={apiKey:(y==null?void 0:y.value)||"",mode:(x==null?void 0:x.value)||"tfidf"};chrome.storage.local.set({xupload_config:e})}y&&y.addEventListener("change",G);x&&x.addEventListener("change",G);function re(){chrome.storage.local.get("xupload_enabled",e=>{const t=e.xupload_enabled!==!1;w&&(w.checked=t)})}w&&w.addEventListener("change",()=>{const e=w.checked;chrome.storage.local.set({xupload_enabled:e})});
