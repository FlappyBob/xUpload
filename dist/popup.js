import{g as q,e as F,f as o,n as x,A as Q,D as X,j as Y,E as Z,F as ee,t as te,p as ne,q as se,v as N,u as R,w as ae,x as oe,z as T,G,d as ie}from"./workflow.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const p of r.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&s(p)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();const V=document.getElementById("count"),B=document.getElementById("scanBtn"),g=document.getElementById("rescanBtn"),l=document.getElementById("progress"),z=document.getElementById("fileList"),w=document.getElementById("lastScan"),b=document.getElementById("autoRescan"),E=document.getElementById("rescanInterval"),C=document.getElementById("apiKey"),L=document.getElementById("matchMode"),m=document.getElementById("exportLogsBtn"),j=document.getElementById("debugFail");q().then(e=>V.textContent=String(e));re();de();k();B.addEventListener("click",async()=>{const e=F("scan-popup");o(e,"scan.popup.click");try{o(e,"service.filesystem.showDirectoryPicker.start");const n=await window.showDirectoryPicker({mode:"read"});o(e,"service.filesystem.showDirectoryPicker.done"),await I(n,!1,e)}catch(n){n.name!=="AbortError"?(x(e,"scan.popup.failed",n),l.textContent="Error scanning folder",B.disabled=!1,g&&(g.disabled=!1)):o(e,"scan.popup.cancelled")}});g&&g.addEventListener("click",async()=>{const e=F("rescan-popup");o(e,"rescan.popup.click");try{o(e,"service.vectordb.getDirectoryHandle.start");const n=await Q();if(!n){x(e,"rescan.popup.no_directory_handle",null),l.textContent="No folder selected yet. Use 'Select folder' first.";return}const t=await n.queryPermission({mode:"read"});if(o(e,"service.filesystem.queryPermission.done",{permission:t}),t!=="granted"){const s=await n.requestPermission({mode:"read"});if(o(e,"service.filesystem.requestPermission.done",{permission:s}),s!=="granted"){x(e,"rescan.popup.permission_denied",{permission:s}),l.textContent="Permission denied. Please select folder again.";return}}await I(n,!0,e)}catch(n){x(e,"rescan.popup.failed",n),l.textContent="Error during rescan. Try selecting folder again.",B.disabled=!1,g&&(g.disabled=!1)}});b&&b.addEventListener("change",K);E&&E.addEventListener("change",K);async function I(e,n,t=F(n?"rescan-popup":"scan-popup")){const s=new Set(["filesystem.collectFiles","vectordb.saveDirectoryHandle","embeddings.extractText","embeddings.tokenize","embeddings.buildVocabulary","embeddings.vectorize","vectordb.upsert","vectordb.saveVocab","chrome.storage.local.set:vocab","chrome.runtime.sendMessage:VOCAB_UPDATED","vectordb.getCount"]);o(t,"scan.popup.start",{incremental:n}),B.disabled=!0,g&&(g.disabled=!0),l.textContent="Scanning files...";try{o(t,"scan.phase.collectFiles.start");const a=await W(e,"");if(l.textContent=`Found ${a.length} files. Checking for changes...`,o(t,"service.filesystem.collectFiles.done",{discoveredFiles:a.length}),j!=null&&j.checked)throw x(t,"scan.debug.fail.injected",{at:"after_collect"}),new Error("Injected debug failure");await X(e),o(t,"service.vectordb.saveDirectoryHandle.done");const r=n?await Y():[],p=new Map(r.map(i=>[i.id,i])),y=new Set;n&&(s.add("vectordb.getAll"),s.add("vectordb.deleteById")),o(t,"scan.phase.read.start");const d=[],v=[];let h=0,P=0;for(let i=0;i<a.length;i++){const{fileHandle:u,path:f}=a[i];y.add(f);try{const c=await u.getFile();if(n){const A=p.get(f);if(A&&A.size===c.size&&A.lastModified===c.lastModified){v.push({path:f,name:c.name,type:c.type||U(c.name),size:c.size,lastModified:c.lastModified,text:A.textPreview}),h++;continue}}const O=await Z(c,f);d.push({path:f,name:c.name,type:c.type||U(c.name),size:c.size,lastModified:c.lastModified,text:O})}catch(c){P++,x(t,"scan.phase.read.file_failed",{path:f,error:c instanceof Error?{message:c.message,stack:c.stack}:c})}i%10===0&&(l.textContent=`Reading files... ${i+1}/${a.length}${h>0?` (${h} unchanged)`:""}`)}o(t,"scan.phase.read.done",{discovered:a.length,toProcess:d.length,unchanged:h,unreadable:P});let D=0;if(n){for(const i of p.keys())y.has(i)||(await ee(i),D++);o(t,"scan.phase.deleted.done",{deleted:D})}if(n&&d.length===0&&D===0){l.textContent=`No changes detected. ${h} files up to date.`,await H(),o(t,"scan.popup.no_changes",{unchanged:h}),o(t,"scan.popup.services_called",Array.from(s));return}l.textContent=`Building vectors... (${d.length} new/modified, ${h} unchanged, ${D} deleted)`;const M=[...d,...v];o(t,"scan.phase.vocab.start",{totalDocs:M.length});const S=M.map(i=>te(i.text));ne(S),o(t,"scan.phase.vocab.done",{vocabDocs:M.length}),n||(await se(),s.add("vectordb.clearAll"),o(t,"service.vectordb.clearAll.done")),o(t,"scan.phase.index.start",{newOrModified:d.length});for(let i=0;i<d.length;i++){const u=d[i],f=N(S[i]),c={id:u.path,name:u.name,path:u.path,type:u.type,size:u.size,lastModified:u.lastModified,vector:f,textPreview:u.text.slice(0,500)};await R(c),i%10===0&&(l.textContent=`Indexing... ${i+1}/${d.length}`)}if(n&&v.length>0){o(t,"scan.phase.index.revectorize.start",{unchanged:v.length}),l.textContent="Updating vectors for unchanged files...";for(let i=0;i<v.length;i++){const u=v[i],f=d.length+i,c=N(S[f]),O=p.get(u.path);await R({...O,vector:c})}}o(t,"scan.phase.index.done",{updated:d.length,revectorized:v.length}),o(t,"scan.phase.persist.start");const _=ae();await oe(_),chrome.storage.local.set({vocab:_},()=>{chrome.runtime.sendMessage({type:"VOCAB_UPDATED"},()=>{chrome.runtime.lastError})}),o(t,"scan.phase.persist.done",{vocabTerms:_.terms.length}),await H();const $=await q();V.textContent=String($),l.textContent=n?`Done! ${d.length} updated, ${D} removed, ${$} total.`:`Done! ${$} files indexed.`,ce(M),o(t,"scan.popup.services_called",Array.from(s)),o(t,"scan.popup.done",{totalIndexed:$,updated:d.length,unchanged:h,deleted:D,unreadable:P})}catch(a){x(t,"scan.popup.failed",a),l.textContent=n?"Error during rescan. Try selecting folder again.":"Error scanning folder"}finally{B.disabled=!1,g&&(g.disabled=!1)}}async function W(e,n){const t=[];for await(const s of e.values()){const a=n?`${n}/${s.name}`:s.name;if(s.kind==="file")t.push({fileHandle:s,path:a});else if(s.kind==="directory"&&!s.name.startsWith(".")){const r=await W(s,a);t.push(...r)}}return t}function U(e){var s;const n=((s=e.split(".").pop())==null?void 0:s.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[n]||"application/octet-stream"}function ce(e){z.innerHTML="";const n=[...e].sort((t,s)=>s.lastModified-t.lastModified);for(const t of n.slice(0,50)){const s=document.createElement("div");s.textContent=t.path,z.appendChild(s)}if(e.length>50){const t=document.createElement("div");t.textContent=`... and ${e.length-50} more`,z.appendChild(t)}}async function re(){const e=await T();b&&(b.checked=e.autoRescanEnabled),E&&(E.value=String(e.rescanIntervalMin))}async function K(){const e=await T();e.autoRescanEnabled=(b==null?void 0:b.checked)??!0,e.rescanIntervalMin=parseInt((E==null?void 0:E.value)??"30",10),await G(e),chrome.runtime.sendMessage({type:"RESCAN_CONFIG_UPDATED"},()=>{chrome.runtime.lastError})}async function H(){const e=await T();e.lastScanTimestamp=Date.now(),await G(e),k()}async function k(){if(!w)return;const e=await T();if(e.lastScanTimestamp===0){w.textContent="Never scanned";return}const n=Date.now()-e.lastScanTimestamp,t=Math.floor(n/6e4);t<1?w.textContent="Last scan: just now":t<60?w.textContent=`Last scan: ${t}m ago`:w.textContent=`Last scan: ${Math.floor(t/60)}h ${t%60}m ago`}function de(){chrome.storage.local.get("xupload_config",e=>{const n=e.xupload_config||{apiKey:"",mode:"tfidf"};C&&(C.value=n.apiKey||""),L&&(L.value=n.mode||"tfidf")})}function J(){const e={apiKey:(C==null?void 0:C.value)||"",mode:(L==null?void 0:L.value)||"tfidf"};chrome.storage.local.set({xupload_config:e})}C&&C.addEventListener("change",J);L&&L.addEventListener("change",J);m&&m.addEventListener("click",async()=>{m.disabled=!0,m.textContent="Collecting...";try{const e=await chrome.runtime.sendMessage({type:"GET_DEBUG_LOGS"});let n=null;try{const[y]=await chrome.tabs.query({active:!0,currentWindow:!0});y!=null&&y.id&&(n=await chrome.tabs.sendMessage(y.id,{type:"GET_CONTENT_LOGS"}))}catch{}const t=ie(),s={exportedAt:new Date().toISOString(),userAgent:navigator.userAgent,background:{logs:(e==null?void 0:e.logs)||[],meta:(e==null?void 0:e.meta)||{}},content:n?{url:n.url,logs:n.logs||[]}:null,popup:{logs:t}},a=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}),r=URL.createObjectURL(a),p=document.createElement("a");p.href=r,p.download=`xupload-debug-${Date.now()}.json`,p.click(),URL.revokeObjectURL(r),m.textContent="Downloaded!",setTimeout(()=>{m.textContent="Export Debug Logs",m.disabled=!1},1500)}catch(e){console.error("[xUpload] Export logs failed:",e),m.textContent="Export failed",m.disabled=!1}});
