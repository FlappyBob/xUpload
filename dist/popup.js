import{g as m,f as x,h as y,t as w,b as v,c as C,v as b,u as E,e as L}from"./vectordb.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&e(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();const u=document.getElementById("count"),f=document.getElementById("scanBtn"),l=document.getElementById("progress"),p=document.getElementById("fileList");m().then(o=>u.textContent=String(o));f.addEventListener("click",async()=>{try{const o=await window.showDirectoryPicker({mode:"read"});await M(o)}catch(o){o.name!=="AbortError"&&(console.error("[xUpload] Scan error:",o),l.textContent="Error scanning folder")}});async function M(o){f.disabled=!0,l.textContent="Scanning files...";const r=await g(o,"");l.textContent=`Found ${r.length} files. Reading...`,await x(o);const t=[];for(let i=0;i<r.length;i++){const{fileHandle:a,path:d}=r[i];try{const c=await a.getFile(),h=await y(c);t.push({path:d,name:c.name,type:c.type||$(c.name),size:c.size,lastModified:c.lastModified,text:h})}catch{}i%10===0&&(l.textContent=`Reading files... ${i+1}/${r.length}`)}l.textContent="Building vectors...";const e=t.map(i=>w(i.text));v(e),await C();for(let i=0;i<t.length;i++){const a=t[i],d=b(e[i]),c={id:a.path,name:a.name,path:a.path,type:a.type,size:a.size,lastModified:a.lastModified,vector:d,textPreview:a.text.slice(0,100)};await E(c),i%10===0&&(l.textContent=`Indexing... ${i+1}/${t.length}`)}const n=L();chrome.storage.local.set({vocab:n},()=>{chrome.runtime.sendMessage({type:"VOCAB_UPDATED"})});const s=await m();u.textContent=String(s),l.textContent=`Done! ${s} files indexed.`,f.disabled=!1,B(t)}async function g(o,r){const t=[];for await(const e of o.values()){const n=r?`${r}/${e.name}`:e.name;if(e.kind==="file")t.push({fileHandle:e,path:n});else if(e.kind==="directory"&&!e.name.startsWith(".")){const s=await g(e,n);t.push(...s)}}return t}function $(o){var e;const r=((e=o.split(".").pop())==null?void 0:e.toLowerCase())||"";return{pdf:"application/pdf",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",txt:"text/plain",csv:"text/csv"}[r]||"application/octet-stream"}function B(o){p.innerHTML="";const r=[...o].sort((t,e)=>e.lastModified-t.lastModified);for(const t of r.slice(0,50)){const e=document.createElement("div");e.textContent=t.path,p.appendChild(e)}if(o.length>50){const t=document.createElement("div");t.textContent=`... and ${o.length-50} more`,p.appendChild(t)}}
