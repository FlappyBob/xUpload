function O(n){const e=n.toLowerCase().trim(),r=[],o=e.match(/[a-z0-9]+/g)||[];r.push(...o);const t=e.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g)||[];r.push(...t);for(let s=0;s<t.length-1;s++)r.push(t[s]+t[s+1]);return r}let f=new Map,w=new Map;function A(n){const e=new Map,r=n.length;for(const t of n){const s=new Set(t);for(const a of s)e.set(a,(e.get(a)||0)+1)}f=new Map,w=new Map;let o=0;for(const[t,s]of e)f.set(t,o++),w.set(t,Math.log((r+1)/(s+1))+1)}function C(){return f.size}function D(n){const e=f.size;if(e===0)return[];const r=new Array(e).fill(0),o=new Map;for(const a of n)o.set(a,(o.get(a)||0)+1);const t=Math.max(...o.values(),1);for(const[a,c]of o){const d=f.get(a);d!==void 0&&(r[d]=c/t*(w.get(a)||1))}let s=0;for(const a of r)s+=a*a;if(s=Math.sqrt(s),s>0)for(let a=0;a<r.length;a++)r[a]/=s;return r}async function T(n){var o;const e=n.name.replace(/[._-]/g," "),r=((o=n.name.split(".").pop())==null?void 0:o.toLowerCase())||"";if(h(r))try{const t=await n.text();return`${e} ${t.slice(0,2e3)}`}catch{return e}if(r==="pdf")try{const t=await S(n);return`${e} ${t.slice(0,2e3)}`}catch{return e}return e}function h(n){return["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"].includes(n)}async function S(n){const e=await n.arrayBuffer(),r=new Uint8Array(e);let o="";const t=Math.min(r.length,5e5);for(let d=0;d<t;d++)o+=String.fromCharCode(r[d]);const s=[],a=/BT\s([\s\S]*?)ET/g;let c;for(;(c=a.exec(o))!==null;){const d=/\(([^)]*)\)/g;let m;for(;(m=d.exec(c[1]))!==null;)s.push(m[1])}return s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim()}function B(){const n=new Array(f.size),e=new Array(f.size);for(const[r,o]of f)n[o]=r,e[o]=w.get(r)||1;return{terms:n,idf:e}}function E(n){f=new Map,w=new Map;for(let e=0;e<n.terms.length;e++)f.set(n.terms[e],e),w.set(n.terms[e],n.idf[e])}const j="xupload_vectors",P=5,l="files",p="dir_handles",y="vocabulary",b="upload_history",g="config";function u(){return new Promise((n,e)=>{const r=indexedDB.open(j,P);r.onupgradeneeded=()=>{const o=r.result;if(o.objectStoreNames.contains(l)&&o.deleteObjectStore(l),o.createObjectStore(l,{keyPath:"id"}),o.objectStoreNames.contains(p)||o.createObjectStore(p),o.objectStoreNames.contains(y)||o.createObjectStore(y),!o.objectStoreNames.contains(b)){const t=o.createObjectStore(b,{keyPath:"id",autoIncrement:!0});t.createIndex("websiteHost","websiteHost",{unique:!1}),t.createIndex("timestamp","timestamp",{unique:!1})}o.objectStoreNames.contains(g)||o.createObjectStore(g)},r.onsuccess=()=>n(r.result),r.onerror=()=>e(r.error)})}async function N(n){const e=await u();return new Promise((r,o)=>{const t=e.transaction(l,"readwrite");t.objectStore(l).put(n),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}async function M(){const n=await u();return new Promise((e,r)=>{const t=n.transaction(l,"readonly").objectStore(l).getAll();t.onsuccess=()=>e(t.result),t.onerror=()=>r(t.error)})}async function q(n){const e=await u();return new Promise((r,o)=>{const s=e.transaction(l,"readonly").objectStore(l).get(n);s.onsuccess=()=>r(s.result??void 0),s.onerror=()=>o(s.error)})}async function _(){const n=await u();return new Promise((e,r)=>{const t=n.transaction(l,"readonly").objectStore(l).count();t.onsuccess=()=>e(t.result),t.onerror=()=>r(t.error)})}async function R(){const n=await u();return new Promise((e,r)=>{const o=n.transaction(l,"readwrite");o.objectStore(l).clear(),o.oncomplete=()=>e(),o.onerror=()=>r(o.error)})}function v(n,e){let r=0,o=0,t=0;for(let s=0;s<n.length;s++)r+=n[s]*e[s],o+=n[s]*n[s],t+=e[s]*e[s];return o===0||t===0?0:r/(Math.sqrt(o)*Math.sqrt(t))}async function U(n,e=5,r){const o=await M();let t=o;if(r){const s=r.split(",").map(c=>c.trim().toLowerCase()),a=o.filter(c=>{var x;const d="."+((x=c.name.split(".").pop())==null?void 0:x.toLowerCase()),m=c.type.toLowerCase();return s.some(i=>i===d||i===m||i.endsWith("/*")&&m.startsWith(i.replace("/*","/")))});a.length>0&&(t=a)}return t.map(s=>({record:s,score:v(n,s.vector)})).sort((s,a)=>a.score-s.score).slice(0,e).filter(s=>s.score>0)}async function z(n){const e=await u();return new Promise((r,o)=>{const t=e.transaction(p,"readwrite");t.objectStore(p).put(n,"main"),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}async function H(){const n=await u();return new Promise((e,r)=>{const t=n.transaction(p,"readonly").objectStore(p).get("main");t.onsuccess=()=>e(t.result??null),t.onerror=()=>r(t.error)})}async function I(n){const e=await q(n);if(!e)return console.error("[xUpload] getFileData: record not found for id:",n),null;const r=await H();if(!r)return console.error("[xUpload] getFileData: no directory handle stored"),null;try{const o=await r.queryPermission({mode:"read"});if(console.log("[xUpload] Directory handle permission:",o),o!=="granted"){const i=await r.requestPermission({mode:"read"});if(console.log("[xUpload] Permission after request:",i),i!=="granted")return console.error("[xUpload] Permission denied for directory handle"),null}const t=e.path.split("/");console.log("[xUpload] Navigating path parts:",t);let s=r;for(let i=0;i<t.length-1;i++)s=await s.getDirectoryHandle(t[i]);const d=await(await(await s.getFileHandle(t[t.length-1])).getFile()).arrayBuffer(),m=new Uint8Array(d);let x="";for(let i=0;i<m.length;i++)x+=String.fromCharCode(m[i]);return{name:e.name,type:e.type,lastModified:e.lastModified,base64:btoa(x)}}catch(o){return console.error("[xUpload] Failed to read file on-demand:",o),null}}async function V(n){const e=await u();return new Promise((r,o)=>{const t=e.transaction(y,"readwrite");t.objectStore(y).put(n,"main"),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}async function F(){const n=await u();return new Promise((e,r)=>{const t=n.transaction(y,"readonly").objectStore(y).get("main");t.onsuccess=()=>e(t.result??null),t.onerror=()=>r(t.error)})}async function k(n){const e=await u();return new Promise((r,o)=>{const t=e.transaction(b,"readwrite");t.objectStore(b).add(n),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}async function L(n,e=50){const r=await u();return new Promise((o,t)=>{const c=r.transaction(b,"readonly").objectStore(b).index("websiteHost").getAll(n,e);c.onsuccess=()=>o(c.result),c.onerror=()=>t(c.error)})}async function $(n){const e=await u();return new Promise((r,o)=>{const t=e.transaction(l,"readwrite");t.objectStore(l).delete(n),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}async function W(){const n=await u();return new Promise((e,r)=>{const t=n.transaction(g,"readonly").objectStore(g).get("rescan");t.onsuccess=()=>e(t.result??{autoRescanEnabled:!0,rescanIntervalMin:30,lastScanTimestamp:0}),t.onerror=()=>r(t.error)})}async function G(n){const e=await u();return new Promise((r,o)=>{const t=e.transaction(g,"readwrite");t.objectStore(g).put(n,"rescan"),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}export{F as a,C as b,k as c,L as d,A as e,R as f,_ as g,B as h,E as i,V as j,I as k,W as l,H as m,z as n,M as o,T as p,$ as q,G as r,U as s,O as t,N as u,D as v};
