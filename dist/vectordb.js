const j=new Set(["a","an","the","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","shall","should","may","might","must","can","could","i","me","my","we","our","you","your","he","him","his","she","her","it","its","they","them","their","this","that","these","those","am","if","or","and","but","not","no","nor","so","as","at","by","for","in","of","on","to","up","from","with","into","out","about","all","any","each","some","such","than","too","very","just","also","how","what","when","where","which","who","here","there","then","only","after","before"]);function P(n){const o=n.toLowerCase().trim(),r=[],t=o.match(/[a-z0-9]+/g)||[];r.push(...t);const e=o.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g)||[];r.push(...e);for(let s=0;s<e.length-1;s++)r.push(e[s]+e[s+1]);return r}function A(n){return P(n).filter(o=>!j.has(o)&&o.length>1)}let p=new Map,h=new Map;function D(n){const o=new Map,r=n.length;for(const e of n){const s=new Set(e);for(const a of s)o.set(a,(o.get(a)||0)+1)}p=new Map,h=new Map;let t=0;for(const[e,s]of o)p.set(e,t++),h.set(e,Math.log((r+1)/(s+1))+1)}function T(){return p.size}function _(n){const o=p.size;if(o===0)return[];const r=new Array(o).fill(0),t=new Map;for(const a of n)t.set(a,(t.get(a)||0)+1);const e=Math.max(...t.values(),1);for(const[a,c]of t){const i=p.get(a);i!==void 0&&(r[i]=c/e*(h.get(a)||1))}let s=0;for(const a of r)s+=a*a;if(s=Math.sqrt(s),s>0)for(let a=0;a<r.length;a++)r[a]/=s;return r}async function B(n,o){var s;const r=n.name.replace(/[._-]/g," "),t=((s=n.name.split(".").pop())==null?void 0:s.toLowerCase())||"",e=o?o.replace(/[/\\._-]/g," "):r;if(v(t))try{const a=await n.text();return`${e} ${a.slice(0,2e3)}`}catch{return e}if(t==="pdf")try{const a=await M(n);return a.length>10?`${e} ${a.slice(0,2e3)}`:`${e} pdf document`}catch{return`${e} pdf document`}return["jpg","jpeg","png","gif","webp","bmp","svg","tiff","heic"].includes(t)?`${e} image photo picture`:["doc","docx"].includes(t)?`${e} document word`:["xls","xlsx"].includes(t)?`${e} spreadsheet excel`:["ppt","pptx"].includes(t)?`${e} presentation slides`:e}function v(n){return["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"].includes(n)}async function M(n){const o=await n.arrayBuffer(),r=new Uint8Array(o);let t="";const e=Math.min(r.length,5e5);for(let i=0;i<e;i++)t+=String.fromCharCode(r[i]);const s=[],a=/BT\s([\s\S]*?)ET/g;let c;for(;(c=a.exec(t))!==null;){const i=/\(([^)]*)\)/g;let u;for(;(u=i.exec(c[1]))!==null;)s.push(u[1])}return s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim()}function E(){const n=new Array(p.size),o=new Array(p.size);for(const[r,t]of p)n[t]=r,o[t]=h.get(r)||1;return{terms:n,idf:o}}function N(n){p=new Map,h=new Map;for(let o=0;o<n.terms.length;o++)p.set(n.terms[o],o),h.set(n.terms[o],n.idf[o])}const q="xupload_vectors",O=5,f="files",y="dir_handles",g="vocabulary",b="upload_history",m="config";function d(){return new Promise((n,o)=>{const r=indexedDB.open(q,O);r.onupgradeneeded=()=>{const t=r.result;if(t.objectStoreNames.contains(f)&&t.deleteObjectStore(f),t.createObjectStore(f,{keyPath:"id"}),t.objectStoreNames.contains(y)||t.createObjectStore(y),t.objectStoreNames.contains(g)||t.createObjectStore(g),!t.objectStoreNames.contains(b)){const e=t.createObjectStore(b,{keyPath:"id",autoIncrement:!0});e.createIndex("websiteHost","websiteHost",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1})}t.objectStoreNames.contains(m)||t.createObjectStore(m)},r.onsuccess=()=>n(r.result),r.onerror=()=>o(r.error)})}async function U(n){const o=await d();return new Promise((r,t)=>{const e=o.transaction(f,"readwrite");e.objectStore(f).put(n),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function x(){const n=await d();return new Promise((o,r)=>{const e=n.transaction(f,"readonly").objectStore(f).getAll();e.onsuccess=()=>o(e.result),e.onerror=()=>r(e.error)})}async function C(n){const o=await d();return new Promise((r,t)=>{const s=o.transaction(f,"readonly").objectStore(f).get(n);s.onsuccess=()=>r(s.result??void 0),s.onerror=()=>t(s.error)})}async function V(){const n=await d();return new Promise((o,r)=>{const e=n.transaction(f,"readonly").objectStore(f).count();e.onsuccess=()=>o(e.result),e.onerror=()=>r(e.error)})}async function z(){const n=await d();return new Promise((o,r)=>{const t=n.transaction(f,"readwrite");t.objectStore(f).clear(),t.oncomplete=()=>o(),t.onerror=()=>r(t.error)})}function S(n,o){let r=0,t=0,e=0;for(let s=0;s<n.length;s++)r+=n[s]*o[s],t+=n[s]*n[s],e+=o[s]*o[s];return t===0||e===0?0:r/(Math.sqrt(t)*Math.sqrt(e))}async function R(n,o=5,r){const t=await x();let e=t;if(r){const s=r.split(",").map(c=>c.trim().toLowerCase()),a=t.filter(c=>{var w;const i="."+((w=c.name.split(".").pop())==null?void 0:w.toLowerCase()),u=c.type.toLowerCase();return s.some(l=>l===i||l===u||l.endsWith("/*")&&u.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:S(n,s.vector)})).sort((s,a)=>a.score-s.score).slice(0,o).filter(s=>s.score>0)}async function $(n){const o=await d();return new Promise((r,t)=>{const e=o.transaction(y,"readwrite");e.objectStore(y).put(n,"main"),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function H(){const n=await d();return new Promise((o,r)=>{const e=n.transaction(y,"readonly").objectStore(y).get("main");e.onsuccess=()=>o(e.result??null),e.onerror=()=>r(e.error)})}async function I(n){const o=await C(n);if(!o)return console.error("[xUpload] getFileData: record not found for id:",n),null;const r=await H();if(!r)return console.error("[xUpload] getFileData: no directory handle stored"),null;try{const t=await r.queryPermission({mode:"read"});if(console.log("[xUpload] Directory handle permission:",t),t!=="granted"){const l=await r.requestPermission({mode:"read"});if(console.log("[xUpload] Permission after request:",l),l!=="granted")return console.error("[xUpload] Permission denied for directory handle"),null}const e=o.path.split("/");console.log("[xUpload] Navigating path parts:",e);let s=r;for(let l=0;l<e.length-1;l++)s=await s.getDirectoryHandle(e[l]);const i=await(await(await s.getFileHandle(e[e.length-1])).getFile()).arrayBuffer(),u=new Uint8Array(i);let w="";for(let l=0;l<u.length;l++)w+=String.fromCharCode(u[l]);return{name:o.name,type:o.type,lastModified:o.lastModified,base64:btoa(w)}}catch(t){return console.error("[xUpload] Failed to read file on-demand:",t),null}}async function L(n){const o=await d();return new Promise((r,t)=>{const e=o.transaction(g,"readwrite");e.objectStore(g).put(n,"main"),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function k(){const n=await d();return new Promise((o,r)=>{const e=n.transaction(g,"readonly").objectStore(g).get("main");e.onsuccess=()=>o(e.result??null),e.onerror=()=>r(e.error)})}async function F(n){const o=await d();return new Promise((r,t)=>{const e=o.transaction(b,"readwrite");e.objectStore(b).add(n),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function W(n,o=50){const r=await d();return new Promise((t,e)=>{const c=r.transaction(b,"readonly").objectStore(b).index("websiteHost").getAll(n,o);c.onsuccess=()=>t(c.result),c.onerror=()=>e(c.error)})}async function G(n){const o=await d();return new Promise((r,t)=>{const e=o.transaction(f,"readwrite");e.objectStore(f).delete(n),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function K(){const n=await d();return new Promise((o,r)=>{const e=n.transaction(m,"readonly").objectStore(m).get("rescan");e.onsuccess=()=>o(e.result??{autoRescanEnabled:!0,rescanIntervalMin:30,lastScanTimestamp:0}),e.onerror=()=>r(e.error)})}async function Y(n){const o=await d();return new Promise((r,t)=>{const e=o.transaction(m,"readwrite");e.objectStore(m).put(n,"rescan"),e.oncomplete=()=>r(),e.onerror=()=>t(e.error)})}async function J(n,o=5,r){let e=(await x()).filter(s=>s.denseVector&&s.denseVector.length>0);if(e.length===0)return[];if(r){const s=r.split(",").map(c=>c.trim().toLowerCase()),a=e.filter(c=>{var w;const i="."+((w=c.name.split(".").pop())==null?void 0:w.toLowerCase()),u=c.type.toLowerCase();return s.some(l=>l===i||l===u||l.endsWith("/*")&&u.startsWith(l.replace("/*","/")))});a.length>0&&(e=a)}return e.map(s=>({record:s,score:S(n,s.denseVector)})).sort((s,a)=>a.score-s.score).slice(0,o).filter(s=>s.score>0)}async function Q(n,o){const r=await d(),t=await new Promise((a,c)=>{const u=r.transaction(m,"readonly").objectStore(m).get("pathMemory");u.onsuccess=()=>a(u.result??{}),u.onerror=()=>c(u.error)}),e=t[n]||[],s=e.indexOf(o);return s!==-1&&e.splice(s,1),e.unshift(o),e.length>20&&(e.length=20),t[n]=e,new Promise((a,c)=>{const i=r.transaction(m,"readwrite");i.objectStore(m).put(t,"pathMemory"),i.oncomplete=()=>a(),i.onerror=()=>c(i.error)})}async function X(n){const o=await d();return new Promise((r,t)=>{const s=o.transaction(m,"readonly").objectStore(m).get("pathMemory");s.onsuccess=()=>{const a=s.result??{};r(a[n]||[])},s.onerror=()=>t(s.error)})}export{k as a,T as b,F as c,R as d,x as e,W as f,V as g,X as h,N as i,J as j,D as k,z as l,E as m,L as n,I as o,K as p,H as q,A as r,Q as s,P as t,U as u,_ as v,$ as w,B as x,G as y,Y as z};
