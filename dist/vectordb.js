function P(n){const e=n.toLowerCase().trim(),r=[],o=e.match(/[a-z0-9]+/g)||[];r.push(...o);const t=e.match(/[\u4e00-\u9fff\u3400-\u4dbf]/g)||[];r.push(...t);for(let s=0;s<t.length-1;s++)r.push(t[s]+t[s+1]);return r}let d=new Map,p=new Map;function D(n){const e=new Map,r=n.length;for(const t of n){const s=new Set(t);for(const a of s)e.set(a,(e.get(a)||0)+1)}d=new Map,p=new Map;let o=0;for(const[t,s]of e)d.set(t,o++),p.set(t,Math.log((r+1)/(s+1))+1)}function q(){return d.size}function A(n){const e=d.size;if(e===0)return[];const r=new Array(e).fill(0),o=new Map;for(const a of n)o.set(a,(o.get(a)||0)+1);const t=Math.max(...o.values(),1);for(const[a,u]of o){const l=d.get(a);l!==void 0&&(r[l]=u/t*(p.get(a)||1))}let s=0;for(const a of r)s+=a*a;if(s=Math.sqrt(s),s>0)for(let a=0;a<r.length;a++)r[a]/=s;return r}async function C(n){var o;const e=n.name.replace(/[._-]/g," "),r=((o=n.name.split(".").pop())==null?void 0:o.toLowerCase())||"";if(y(r))try{const t=await n.text();return`${e} ${t.slice(0,2e3)}`}catch{return e}if(r==="pdf")try{const t=await x(n);return`${e} ${t.slice(0,2e3)}`}catch{return e}return e}function y(n){return["txt","md","csv","json","xml","html","htm","js","ts","py","java","c","cpp","css","log","yaml","yml","toml","ini","rtf"].includes(n)}async function x(n){const e=await n.arrayBuffer(),r=new Uint8Array(e);let o="";const t=Math.min(r.length,5e5);for(let l=0;l<t;l++)o+=String.fromCharCode(r[l]);const s=[],a=/BT\s([\s\S]*?)ET/g;let u;for(;(u=a.exec(o))!==null;){const l=/\(([^)]*)\)/g;let f;for(;(f=l.exec(u[1]))!==null;)s.push(f[1])}return s.join(" ").replace(/\\n/g," ").replace(/\s+/g," ").trim()}function z(){const n=new Array(d.size),e=new Array(d.size);for(const[r,o]of d)n[o]=r,e[o]=p.get(r)||1;return{terms:n,idf:e}}function B(n){d=new Map,p=new Map;for(let e=0;e<n.terms.length;e++)d.set(n.terms[e],e),p.set(n.terms[e],n.idf[e])}const h="xupload_vectors",b=4,i="files",w="dir_handles";function m(){return new Promise((n,e)=>{const r=indexedDB.open(h,b);r.onupgradeneeded=()=>{const o=r.result;o.objectStoreNames.contains(i)&&o.deleteObjectStore(i),o.createObjectStore(i,{keyPath:"id"}),o.objectStoreNames.contains(w)||o.createObjectStore(w)},r.onsuccess=()=>n(r.result),r.onerror=()=>e(r.error)})}async function U(n){const e=await m();return new Promise((r,o)=>{const t=e.transaction(i,"readwrite");t.objectStore(i).put(n),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}async function S(){const n=await m();return new Promise((e,r)=>{const t=n.transaction(i,"readonly").objectStore(i).getAll();t.onsuccess=()=>e(t.result),t.onerror=()=>r(t.error)})}async function j(n){const e=await m();return new Promise((r,o)=>{const s=e.transaction(i,"readonly").objectStore(i).get(n);s.onsuccess=()=>r(s.result??void 0),s.onerror=()=>o(s.error)})}async function E(){const n=await m();return new Promise((e,r)=>{const t=n.transaction(i,"readonly").objectStore(i).count();t.onsuccess=()=>e(t.result),t.onerror=()=>r(t.error)})}async function H(){const n=await m();return new Promise((e,r)=>{const o=n.transaction(i,"readwrite");o.objectStore(i).clear(),o.oncomplete=()=>e(),o.onerror=()=>r(o.error)})}function M(n,e){let r=0,o=0,t=0;for(let s=0;s<n.length;s++)r+=n[s]*e[s],o+=n[s]*n[s],t+=e[s]*e[s];return o===0||t===0?0:r/(Math.sqrt(o)*Math.sqrt(t))}async function N(n,e=5,r){const o=await S();let t=o;if(r){const s=r.split(",").map(u=>u.trim().toLowerCase()),a=o.filter(u=>{var g;const l="."+((g=u.name.split(".").pop())==null?void 0:g.toLowerCase()),f=u.type.toLowerCase();return s.some(c=>c===l||c===f||c.endsWith("/*")&&f.startsWith(c.replace("/*","/")))});a.length>0&&(t=a)}return t.map(s=>({record:s,score:M(n,s.vector)})).sort((s,a)=>a.score-s.score).slice(0,e).filter(s=>s.score>0)}async function T(n){const e=await m();return new Promise((r,o)=>{const t=e.transaction(w,"readwrite");t.objectStore(w).put(n,"main"),t.oncomplete=()=>r(),t.onerror=()=>o(t.error)})}async function v(){const n=await m();return new Promise((e,r)=>{const t=n.transaction(w,"readonly").objectStore(w).get("main");t.onsuccess=()=>e(t.result??null),t.onerror=()=>r(t.error)})}async function _(n){const e=await j(n);if(!e)return console.error("[xUpload] getFileData: record not found for id:",n),null;const r=await v();if(!r)return console.error("[xUpload] getFileData: no directory handle stored"),null;try{const o=await r.queryPermission({mode:"read"});if(console.log("[xUpload] Directory handle permission:",o),o!=="granted"){const c=await r.requestPermission({mode:"read"});if(console.log("[xUpload] Permission after request:",c),c!=="granted")return console.error("[xUpload] Permission denied for directory handle"),null}const t=e.path.split("/");console.log("[xUpload] Navigating path parts:",t);let s=r;for(let c=0;c<t.length-1;c++)s=await s.getDirectoryHandle(t[c]);const l=await(await(await s.getFileHandle(t[t.length-1])).getFile()).arrayBuffer(),f=new Uint8Array(l);let g="";for(let c=0;c<f.length;c++)g+=String.fromCharCode(f[c]);return{name:e.name,type:e.type,lastModified:e.lastModified,base64:btoa(g)}}catch(o){return console.error("[xUpload] Failed to read file on-demand:",o),null}}export{q as a,D as b,H as c,_ as d,z as e,T as f,E as g,C as h,B as i,N as s,P as t,U as u,A as v};
